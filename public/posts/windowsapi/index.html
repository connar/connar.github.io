<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Learning about Windows API | Journal of Connar</title>
<meta name="keywords" content="Windows API">
<meta name="description" content="Intro
As I am starting to take a turn of interest into malware analysis and development, I was required to understand what the Windows API really is. So this post is basically my notes on what windows api is and a few examples of it.
Was exactly is an API
When you use a Windows application, have you ever wondered how it seamlessly interacts with the operating system? The magic behind this interaction is the Windows API. Generally, an api allows for two pieces of software to interact upon another. When it comes to programming, it allows your code to interact with the windows operating system.
Let&rsquo;s dive into what the Windows API is and why it&rsquo;s crucial for software development on the Windows platform - but also for red teamers, threat actors and blue teamers as well.">
<meta name="author" content="connar">
<link rel="canonical" href="http://localhost:1313/posts/windowsapi/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.1665878c578779cd11d4dc626b2c0e032a8b9c1dcf7d37f819200b4bc208b6a7.css" integrity="sha256-FmWHjFeHec0R1NxiaywOAyqLnB3PfTf4GSALS8IItqc=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/windowsapi/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Journal of Connar (Alt + H)">Journal of Connar</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/mychallenges/" title="My Challenges">
                    <span>My Challenges</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Learning about Windows API
    </h1>
    <div class="post-meta"><span title='2024-03-11 20:03:02 +0200 +0200'>March 11, 2024</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;connar

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a></li>
                <li>
                    <a href="#was-exactly-is-an-api" aria-label="Was exactly is an API">Was exactly is an API</a></li>
                <li>
                    <a href="#the-functionality-of-the-windows-api" aria-label="The functionality of the Windows API">The functionality of the Windows API</a></li>
                <li>
                    <a href="#windows-jobs" aria-label="Windows Jobs">Windows Jobs</a></li>
                <li>
                    <a href="#layers-of-the-windows-api" aria-label="Layers of the Windows API">Layers of the Windows API</a></li>
                <li>
                    <a href="#header-files-vs-dll-files" aria-label="Header files vs Dll files">Header files vs Dll files</a><ul>
                        
                <li>
                    <a href="#header-files" aria-label="Header files">Header files</a></li>
                <li>
                    <a href="#dll-files" aria-label="Dll files">Dll files</a><ul>
                        
                <li>
                    <a href="#linking-process" aria-label="Linking Process">Linking Process</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#windows-data-types" aria-label="Windows data types">Windows data types</a><ul>
                        
                <li>
                    <a href="#function-naming-conventions" aria-label="Function naming conventions">Function naming conventions</a></li></ul>
                </li>
                <li>
                    <a href="#demo-1---viewing-the-api-calls-from-python" aria-label="Demo 1 - Viewing the API calls from python">Demo 1 - Viewing the API calls from python</a><ul>
                        
                <li>
                    <a href="#step-1---open-python" aria-label="Step 1 - Open python">Step 1 - Open python</a></li>
                <li>
                    <a href="#step-2---attaching-python-process-to-windbg" aria-label="Step 2 - Attaching python process to WinDbg">Step 2 - Attaching python process to WinDbg</a></li>
                <li>
                    <a href="#step-3---putting-a-breakpoint-at-createfilew" aria-label="Step 3 - Putting a breakpoint at CreateFileW">Step 3 - Putting a breakpoint at CreateFileW</a></li></ul>
                </li>
                <li>
                    <a href="#demo-2---viewing-the-api-calls-from-notepadexe" aria-label="Demo 2 - Viewing the API calls from notepad.exe">Demo 2 - Viewing the API calls from notepad.exe</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h3>
<p>As I am starting to take a turn of interest into malware analysis and development, I was required to understand what the Windows API really is. So this post is basically my notes on what windows api is and a few examples of it.</p>
<h3 id="was-exactly-is-an-api">Was exactly is an API<a hidden class="anchor" aria-hidden="true" href="#was-exactly-is-an-api">#</a></h3>
<p>When you use a Windows application, have you ever wondered how it seamlessly interacts with the operating system? The magic behind this interaction is the Windows API. Generally, an api allows for two pieces of software to interact upon another. When it comes to programming, it allows your code to interact with the windows operating system.<br>
Let&rsquo;s dive into what the Windows API is and why it&rsquo;s crucial for software development on the Windows platform - but also for red teamers, threat actors and blue teamers as well.</p>
<h3 id="the-functionality-of-the-windows-api">The functionality of the Windows API<a hidden class="anchor" aria-hidden="true" href="#the-functionality-of-the-windows-api">#</a></h3>
<p>The Windows API, or Windows Application Programming Interface, is an extensive collection of functions and procedures supplied by the Microsoft Windows operating system that utilizes memory addresses to access resources, manage memory, pass parameters to methods and much more. Imagine it as a toolkit that enables software developers to build applications capable of interacting with the Windows environment. For instance, tasks such as displaying content on the screen, modifying files, or querying the registry can all be accomplished through the Windows API. Microsoft provides thorough documentation for the Windows API, which you can explore <a href="https://learn.microsoft.com/en-us/windows/win32/apiindex/windows-api-list">here</a>.</p>
<p>Basically, when an application needs to perform an operation, it uses the Win32 API, which translates the request into SYSCALLs. These SYSCALLs are then executed by the kernel to make the necessary changes or perform the desired actions. We can see an overview of this process in the following diagram:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi1.png" alt="windows api overview diagram"  />
</p>
<p>More specifically and for giving an example, the function flow of the calls made by a program that just wants to use the FileStream.Read method would be the following:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi3.png" alt="windows api overview diagram"  />
</p>
<h3 id="windows-jobs">Windows Jobs<a hidden class="anchor" aria-hidden="true" href="#windows-jobs">#</a></h3>
<p>A Windows Job is directly supported by the Windows API through functions that allow you to create, manage, and monitor job objects. These job objects are part of the Windows OS&rsquo;s resource management capabilities. In simpler terms, a job is a kernel object that is responsible for managing one or more processes that run on the system. Functions like CreateJobObject and OpenJobObject are part of the Windows API and provide the necessary tools to implement job management.</p>
<ul>
<li><strong>CreateJobObject</strong>: This function is part of the Windows API and is used to create a job object. It provides a handle to the newly created job object, which can then be used with other job management functions:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>HANDLE hJob <span style="color:#f92672">=</span> CreateJobObject(NULL, TEXT(<span style="color:#e6db74">&#34;ExampleJob&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (hJob <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Handle error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><strong>OpenJobObject</strong>: This function is part of the Windows API and allows you to open an existing job object by name. It returns a handle to the job object, enabling further manipulation or querying:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>HANDLE hJob <span style="color:#f92672">=</span> OpenJobObject(JOB_OBJECT_ALL_ACCESS, FALSE, TEXT(<span style="color:#e6db74">&#34;ExampleJob&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (hJob <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Handle error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><strong>AssignProcessToJobObject</strong>: This function assigns a process to a job object. The process will then be subject to the limits and rules of the job object:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a job object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HANDLE hJob <span style="color:#f92672">=</span> CreateJobObject(NULL, TEXT(<span style="color:#e6db74">&#34;ExampleJob&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (hJob <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;CreateJobObject failed with error: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a process to assign to the job object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    STARTUPINFO si;
</span></span><span style="display:flex;"><span>    PROCESS_INFORMATION pi;
</span></span><span style="display:flex;"><span>    ZeroMemory(<span style="color:#f92672">&amp;</span>si, <span style="color:#66d9ef">sizeof</span>(si));
</span></span><span style="display:flex;"><span>    si.cb <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(si);
</span></span><span style="display:flex;"><span>    ZeroMemory(<span style="color:#f92672">&amp;</span>pi, <span style="color:#66d9ef">sizeof</span>(pi));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>CreateProcess(NULL, TEXT(<span style="color:#e6db74">&#34;notepad.exe&#34;</span>), NULL, NULL, FALSE, <span style="color:#ae81ff">0</span>, NULL, NULL, <span style="color:#f92672">&amp;</span>si, <span style="color:#f92672">&amp;</span>pi)) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;CreateProcess failed with error: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>        CloseHandle(hJob);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Assign the process to the job object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>AssignProcessToJobObject(hJob, pi.hProcess)) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;AssignProcessToJobObject failed with error: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>        CloseHandle(pi.hProcess);
</span></span><span style="display:flex;"><span>        CloseHandle(pi.hThread);
</span></span><span style="display:flex;"><span>        CloseHandle(hJob);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Process assigned to job object successfully.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Wait for the process to exit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    WaitForSingleObject(pi.hProcess, INFINITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Clean up handles
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CloseHandle(pi.hProcess);
</span></span><span style="display:flex;"><span>    CloseHandle(pi.hThread);
</span></span><span style="display:flex;"><span>    CloseHandle(hJob);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="layers-of-the-windows-api">Layers of the Windows API<a hidden class="anchor" aria-hidden="true" href="#layers-of-the-windows-api">#</a></h3>
<p>Before we dive into the functionality of the API, it&rsquo;s important to understand the layers and terminologies we&rsquo;ll be referring to. The Win32 API, more commonly known as the Windows API, consists of several components that define its structure and organization. To simplify this, we&rsquo;ll break down the Win32 API using a top-down approach: the API itself is the top layer, and the parameters for specific calls are the bottom layer. The table below outlines this top-down structure at a high level, with more detailed explanations to follow:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi2.png" alt="windows api layers"  />
</p>
<h3 id="header-files-vs-dll-files">Header files vs Dll files<a hidden class="anchor" aria-hidden="true" href="#header-files-vs-dll-files">#</a></h3>
<h4 id="header-files">Header files<a hidden class="anchor" aria-hidden="true" href="#header-files">#</a></h4>
<p>Header files contain definitions of functions that make up the API, such as <code>ReadProcessMemory</code>, but they do not include the actual code that implements these functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Open the process with PROCESS_VM_READ access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD processID <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>; <span style="color:#75715e">// Replace with the target process ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HANDLE hProcess <span style="color:#f92672">=</span> OpenProcess(PROCESS_VM_READ, FALSE, processID);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (hProcess <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Failed to open process. Error: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> GetLastError() <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Address in the target process to read from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    LPCVOID baseAddress <span style="color:#f92672">=</span> (LPCVOID)<span style="color:#ae81ff">0x7FF6ABCDEF00</span>; <span style="color:#75715e">// Replace with the actual address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SIZE_T bytesRead;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">256</span>]; <span style="color:#75715e">// Buffer to store the read data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read memory from the target process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (ReadProcessMemory(hProcess, baseAddress, buffer, <span style="color:#66d9ef">sizeof</span>(buffer), <span style="color:#f92672">&amp;</span>bytesRead)) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Read &#34;</span> <span style="color:#f92672">&lt;&lt;</span> bytesRead <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; bytes from the process.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Do something with the data in buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Failed to read process memory. Error: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> GetLastError() <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Close the handle to the process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CloseHandle(hProcess);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, we imported the windows.h header file that contains the declarations for all the Windows API functions, including <code>ReadProcessMemory</code>.<br>
The implementation code is found in DLL files, which stands for Dynamic Link Libraries. A single DLL file can provide the implementations for multiple header files.</p>
<p>So basically, the windows.h header file includes, amongst others, the declaration of the <code>ReadProcessMemory</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">ReadProcessMemory</span>(
</span></span><span style="display:flex;"><span>  HANDLE  hProcess,
</span></span><span style="display:flex;"><span>  LPCVOID lpBaseAddress,
</span></span><span style="display:flex;"><span>  LPVOID  lpBuffer,
</span></span><span style="display:flex;"><span>  SIZE_T  nSize,
</span></span><span style="display:flex;"><span>  SIZE_T  <span style="color:#f92672">*</span>lpNumberOfBytesRead
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>This declaration tells the compiler what the function looks like, its name, return type, and parameters. However, it does not provide the actual implementation of the function. The code of this function is inside the corresponding dll.</p>
<h4 id="dll-files">Dll files<a hidden class="anchor" aria-hidden="true" href="#dll-files">#</a></h4>
<p>When a function like <code>ReadProcessMemory</code> is called, the system locates the corresponding DLL that contains the implementation of this function. For many Windows API functions, this DLL is kernel32.dll. How is the header file connected with the dll and the function name call is described below:</p>
<h5 id="linking-process">Linking Process<a hidden class="anchor" aria-hidden="true" href="#linking-process">#</a></h5>
<ol>
<li><strong>Compilation</strong>: During the compilation, the compiler uses the header files to understand the structure and usage of the functions. It ensures that the function calls in our code match the declarations in the header files.</li>
<li><strong>Linking</strong>: During the linking phase, the linker resolves the references to these functions by linking them to the corresponding DLL files that contain the actual implementation. For ReadProcessMemory, the linker ensures that the call in our code will be linked to the kernel32.dll.</li>
<li><strong>Runtime</strong>: At runtime, when the program execution reaches a call to ReadProcessMemory, the Windows operating system loads kernel32.dll (if it is not already loaded) and resolves the address of the ReadProcessMemory function. The program then jumps to that address to execute the function.</li>
</ol>
<p>So when our previous code calls the ReadProcessMemory, the process that happens can be summorized as:</p>
<ol>
<li><strong>Include Header File</strong>: You include windows.h in your source file. This header file contains the declaration of ReadProcessMemory:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span></code></pre></div><ol start="2">
<li><strong>Link to DLL</strong>: The linker ensures that your program is linked with kernel32.dll, where ReadProcessMemory is implemented.</li>
<li><strong>Call the Function</strong>: When you call ReadProcessMemory in your code, the compiled program contains a placeholder that will be resolved to the actual address of the function in kernel32.dll at runtime:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ReadProcessMemory(hProcess, baseAddress, buffer, <span style="color:#66d9ef">sizeof</span>(buffer), <span style="color:#f92672">&amp;</span>bytesRead)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Successfully read memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ol start="4">
<li><strong>Execution</strong>: At runtime, when ReadProcessMemory is called, the operating system ensures that kernel32.dll is loaded into memory, finds the ReadProcessMemory function within the DLL, and executes it.</li>
</ol>
<h3 id="windows-data-types">Windows data types<a hidden class="anchor" aria-hidden="true" href="#windows-data-types">#</a></h3>
<p>Windows data types and conventions refer to the specific data types and coding conventions used in Windows programming. These conventions are established by Microsoft to ensure consistency and compatibility across Windows applications. Here&rsquo;s a breakdown of some key aspects:</p>
<ul>
<li><strong>Data Types</strong>:
<ul>
<li><strong>Basic Data Types</strong>: Windows programming uses basic data types like int, char, float, etc., similar to standard C and C++ programming.</li>
<li><strong>Platform-Specific Data Types</strong>: Windows also defines its own data types, often prefixed with DWORD, LP, HANDLE, etc. These data types are designed to accommodate various platform-specific requirements, such as memory management, inter-process communication, and file handling.</li>
<li><strong>Unicode Support</strong>: Windows APIs often use Unicode for text manipulation. As a result, data types like wchar_t (wide character) and functions prefixed with W (e.g., CreateWindowW) are commonly used to support Unicode strings.</li>
<li><strong>Pointer Types</strong>: Windows APIs use pointer types like LPVOID (pointer to void), LPCSTR (pointer to constant string), LPWSTR (pointer to wide string), etc., for memory management and passing parameters.</li>
</ul>
</li>
<li><strong>Conventions</strong>:
<ul>
<li><strong>Naming Conventions</strong>: Windows APIs and data types typically follow a consistent naming convention. For example, function names often start with a capital letter (e.g., CreateWindow) and use CamelCase. Constants are often named in uppercase (e.g., HWND_TOPMOST).</li>
<li><strong>Error Handling</strong>: Windows APIs often use error codes, typically represented as DWORD values, to indicate the success or failure of operations. Functions usually return BOOL values (TRUE for success, FALSE for failure) or specific error codes (e.g., ERROR_SUCCESS, ERROR_FILE_NOT_FOUND).</li>
</ul>
</li>
</ul>
<h4 id="function-naming-conventions">Function naming conventions<a hidden class="anchor" aria-hidden="true" href="#function-naming-conventions">#</a></h4>
<p>Many times you will come upon function that generally look the same, but usually they will have a suffix to them. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>Function()  <span style="color:#75715e">// This is the generic name and is compatible with both ANSI and Unicode encodings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FunctionA() <span style="color:#75715e">// Indicates ANSI encoding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FunctionW() <span style="color:#75715e">// Indicates Unicode encoding
</span></span></span></code></pre></div><p>You will also come across other functions with the suffix Ex like <code>FunctionEx()</code> which stands for extended. So a function ending with Ex provides extended control over the execution of a specific task:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi4.png" alt="windows api ex"  />
</p>
<p>There are many other different function naming conventions that are less straight forward like:</p>
<ul>
<li>NtCreateFile()</li>
<li>GetFileAttributesExA()
but their use can be matched to the components to which the function belongs with the help of the following table:</li>
</ul>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi5.png" alt="windows api ex"  />
</p>
<h3 id="demo-1---viewing-the-api-calls-from-python">Demo 1 - Viewing the API calls from python<a hidden class="anchor" aria-hidden="true" href="#demo-1---viewing-the-api-calls-from-python">#</a></h3>
<p>We are now going to use python to open a file with write permissions and monitor the journey of the calls being made to the system.</p>
<h4 id="step-1---open-python">Step 1 - Open python<a hidden class="anchor" aria-hidden="true" href="#step-1---open-python">#</a></h4>
<p>To start of, we need to open a python terminal and write the following line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> open(<span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">connar</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Desktop</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">proof_of_concept.txt&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>)
</span></span></code></pre></div><p>Before running this line, let&rsquo;s open WinDbg and attach the python process to it.</p>
<h4 id="step-2---attaching-python-process-to-windbg">Step 2 - Attaching python process to WinDbg<a hidden class="anchor" aria-hidden="true" href="#step-2---attaching-python-process-to-windbg">#</a></h4>
<p>To attach the python process to WinDbg, simply go to File &ndash;&gt; Attach to Process &ndash;&gt; Double click python process.</p>
<h4 id="step-3---putting-a-breakpoint-at-createfilew">Step 3 - Putting a breakpoint at CreateFileW<a hidden class="anchor" aria-hidden="true" href="#step-3---putting-a-breakpoint-at-createfilew">#</a></h4>
<p>Because python uses CreateFileW (the Unicode version as we previously discussed) to write to files, we need to breakpoint the calls being made to CreateFileW:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi6.png" alt="windbg bm"  />
</p>
<p>We can see that after breakpointing the calls to CreateFileW, resuming the process and running it, we got a hit on KERNELBASE!CreateFileW. The reason its KERNELBASE and not KERNEL32 is that Microsoft at some point decided to move part of functionality of KERNEL32 to KERNELBASE.</p>
<p>Now, remember that we previously mentioned Win32 API uses memory addresses? Let&rsquo;s view the contents of the rcx register by using the <em>display unicode</em> command:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi7.png" alt="windbg bm"  />
</p>
<p>Aaand we got the parameter given to our open() python function, or in other words the CreateFileW method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>HANDLE <span style="color:#a6e22e">CreateFileW</span>(
</span></span><span style="display:flex;"><span>  [in]           LPCWSTR               lpFileName,  <span style="color:#f92672">&lt;--</span> First parameter is the filename
</span></span><span style="display:flex;"><span>  [in]           DWORD                 dwDesiredAccess,
</span></span><span style="display:flex;"><span>  [in]           DWORD                 dwShareMode,
</span></span><span style="display:flex;"><span>  [in, optional] LPSECURITY_ATTRIBUTES lpSecurityAttributes,
</span></span><span style="display:flex;"><span>  [in]           DWORD                 dwCreationDisposition,
</span></span><span style="display:flex;"><span>  [in]           DWORD                 dwFlagsAndAttributes,
</span></span><span style="display:flex;"><span>  [in, optional] HANDLE                hTemplateFile
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>In this simple example, we got a general idea of how a simple script that on the outside seems to just use the <code>open()</code> function, ended up calling CreateFileW and passing as argument (found in the rcx) the first parameter that CreateFileW accepts, which is the name of the file we are trying to open.</p>
<p>This is more or less what is happening behind the scenes when we call functions on our programs. WinAPI calls the corresponding dll&rsquo;s to take care of the task and communicate with the kernel.</p>
<h3 id="demo-2---viewing-the-api-calls-from-notepadexe">Demo 2 - Viewing the API calls from notepad.exe<a hidden class="anchor" aria-hidden="true" href="#demo-2---viewing-the-api-calls-from-notepadexe">#</a></h3>
<p>In the previous demo we saw the series of calls that happened in Windows API when we tried to write to a file using a python script, with the help of WinDbg.<br>
In this demo we are about to see the same thing but for notepad.exe this time and also by using a different program named ApiMonitor.</p>
<p>ApiMonitor is a tool used to &hellip; well, monitor API calls being made by applications.<br>
Upon downloading and opening it, we need to find the following three API calls and check them:</p>
<ul>
<li>Kernel32!CreateFileA</li>
<li>Kernel32!CreateFileW</li>
<li>ntdll!NtCreateFile</li>
</ul>
<p>These are some of the most popular API calls that usually happen when trying to create a file, so we will check them in order to only monitor them. To check them, you need to navigate to the &ldquo;API Filter&rdquo; pane, click display and then CTRL+F searching for the name &ldquo;CreateFile&rdquo;:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi8.png" alt="apimonitor1"  />
</p>
<p>After we have checked the mentioned three API calls, let&rsquo;s monitor the notepad.exe process by navigating to File&ndash;&gt;Monitor New Process&hellip; and then finding the notepad.exe:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi9.png" alt="apimonitor2"  />
</p>
<p>Note that if you don&rsquo;t have a file named &ldquo;filetest.txt&rdquo;, the program will create it for you.</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi10.png" alt="apimonitor3"  />
</p>
<p>We can now see the API calls that notepad.exe made. We can view more info about one of those calls - such as the parameters used - by clicking one of them:</p>
<p><img loading="lazy" src="/posts/windowsapi/windowsapi11.png" alt="apimonitor3"  />
</p>
<p>What we can tell from the parameters is that they exactly match the structure of the CreateFileW we saw earlier. Another thing we can note by also looking back at a previous image, is that CreateFileW was made by user mode and ended up being executed by the kernel mode, thus the extra call to NtCreateFile (which comes from NtDll).</p>
<p><strong>References</strong></p>
<blockquote>
    <ul>
        <li> [1] <a href="https://www.youtube.com/watch?v=S4lQwJawOzI">Guided Hacking: <i>What is the Windows API? What is Windows.h?</i></a></li>
        <li> [2] <a href="https://www.youtube.com/watch?v=nqJy3yCTqes">Nir Lichtman: <i>How Windows API Works Under the Hood</i></a></li>
        <li> [3] <a href="https://kavigihan.medium.com/introduction-to-windows-api-970f714ba700">Kavishka Gihan: <i>Introduction to Windows API</i></a></li>
        <li> [3] <a href="https://samsclass.info/126/proj/PMA403.htm">PMA 403. API Monitor</a></li>
        <li> [4] <a href="https://assets.ctfassets.net/9n3x4rtjlya6/6isCHPOhLq8eA0U0AKuAyY/3d02ef18b8dc2fca10179d8ec5122235/Pavel_Yosifovich_Windows_Internals_for_.NET_developers.pdf">Pavel Yosifovich: <i>Windows Internals for .NET Developers
</i></a></li>
    </ul>
</blockquote>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/windows-api/">Windows API</a></li>
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Journal of Connar</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
